/* eslint-env node */
'use strict';

var gulp = require('gulp');

var sort = require('gulp-sort');

var iconfont = require('gulp-iconfont');

var fs = require('fs');

var svgpath = require('svgpath');

var svgmin = require('gulp-svgmin');
/**
 * Normalize file sort order across platforms (OS X vs Linux, maybe others).
 *
 * Before: `[..., 'eye-disabled', 'eye', ...]`
 * After:  `[..., 'eye', 'eye-disabled', ...]`
 *
 * Order of appearance impacts assigned Unicode codepoints, and sometimes build diffs.
 *
 * @see https://github.com/nfroidure/svgicons2svgfont/pull/82
 * @see https://github.com/nfroidure/svgicons2svgfont/blob/master/src/filesorter.js
 * @see http://support.ecisolutions.com/doc-ddms/help/reportsmenu/ascii_sort_order_chart.htm
 */


function sortIconFilesNormalized(file1, file2) {
  return file1.replace(/-/g, '~').localeCompare(file2.replace(/-/g, '~'), 'en-US');
}

function createCopyright() {
  return "/**\n * @license\n * Copyright (c) 2017 - 2022 Vaadin Ltd.\n * This program is available under Apache License Version 2.0, available at https://vaadin.com/license/\n */";
}

function createIconset(folder, filenames) {
  var idPrefix = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';
  var output = "<svg xmlns=\"http://www.w3.org/2000/svg\">\n<defs>\n";
  filenames.forEach(function (filename) {
    // Skip non-svg files
    if (filename.indexOf('.svg') === -1) {
      return;
    }

    var content = fs.readFileSync(folder + filename, 'utf-8');
    var path = content.match(/<path( fill-rule="evenodd" clip-rule="evenodd")* d="([^"]*)"/);

    if (path) {
      var newPath = new svgpath(path[2]).scale(1000 / 24, 1000 / 24).round(0).toString();
      var name = filename.replace('.svg', '').replace(/\s/g, '-').toLowerCase();
      var attrs = path[1] !== undefined ? path[1] : '';
      output += "<g id=\"".concat(idPrefix).concat(name, "\"><path d=\"").concat(newPath, "\"").concat(attrs, "></path></g>\n");
    } else {
      throw new Error("Unexpected SVG content: ".concat(filename));
    }
  });
  output += "</defs>\n</svg>";
  return output;
}

gulp.task('icons', /*#__PURE__*/babelHelpers.asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {
  var folder, glyphs;
  return regeneratorRuntime.wrap(function _callee$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          folder = 'icons/svg/';
          // Optimize the source files
          gulp.src(folder + '*.svg').pipe(svgmin({
            plugins: [{
              removeTitle: true
            }, {
              removeViewBox: false
            }, {
              cleanupNumericValues: {
                floatPrecision: 6
              }
            }, {
              convertPathData: {
                floatPrecision: 6
              }
            }]
          })).pipe(gulp.dest(folder)).on('finish', function () {
            // iron-iconset-svg
            fs.readdir(folder, function (err, filenames) {
              if (err) {
                console.error(err);
                return;
              }

              filenames.sort(sortIconFilesNormalized);
              var ironIcons = "".concat(createCopyright(), "\nimport '@polymer/iron-iconset-svg/iron-iconset-svg.js';\nimport './version.js';\n\nconst $_documentContainer = document.createElement('template');\n\n$_documentContainer.innerHTML = `<iron-iconset-svg size=\"1000\" name=\"lumo\">\n").concat(createIconset(folder, filenames), "\n</iron-iconset-svg>`;\n\ndocument.head.appendChild($_documentContainer.content);\n");
              fs.writeFile('iconset.js', ironIcons, function (err) {
                if (err) {
                  return console.error(err);
                }
              });
              var vaadinIcons = "".concat(createCopyright(), "\nimport '@vaadin/icon/vaadin-iconset.js';\nimport './version.js';\n\nconst $_documentContainer = document.createElement('template');\n\n$_documentContainer.innerHTML = `<vaadin-iconset name=\"lumo\" size=\"1000\">\n").concat(createIconset(folder, filenames, 'lumo:'), "\n</vaadin-iconset>`;\n\ndocument.head.appendChild($_documentContainer.content);\n");
              fs.writeFile('vaadin-iconset.js', vaadinIcons, function (err) {
                if (err) {
                  return console.error(err);
                }
              });
            }); // icon font

            gulp.src(folder + '*.svg').pipe(sort({
              comparator: function comparator(file1, file2) {
                return sortIconFilesNormalized(file1.relative, file2.relative);
              }
            })).pipe(iconfont({
              fontName: 'lumo-icons',
              formats: ['woff'],
              fontHeight: 1000,
              ascent: 850,
              descent: 150,
              fixedWidth: true,
              normalize: true,
              timestamp: 1 // Truthy!

            })).on('glyphs', function (glyphData) {
              // Store for later use
              glyphs = glyphData;
            }).pipe(gulp.dest('.')).on('finish', function () {
              // Generate base64 version of the font
              var lumoIconsWoff = fs.readFileSync('lumo-icons.woff'); // Write the output to font-icons.js

              var output = createCopyright();
              output += "\nimport './version.js';\n\nconst $_documentContainer = document.createElement('template');\n\n$_documentContainer.innerHTML = `\n  <style>\n    @font-face {\n      font-family: 'lumo-icons';\n      src: url(data:application/font-woff;charset=utf-8;base64,".concat(lumoIconsWoff.toString('base64'), ") format('woff');\n      font-weight: normal;\n      font-style: normal;\n    }\n\n    html {\n");
              glyphs.forEach(function (g) {
                var name = g.name.replace(/\s/g, '-').toLowerCase();
                var unicode = '\\\\' + g.unicode[0].charCodeAt(0).toString(16);
                output += "      --lumo-icons-".concat(name, ": \"").concat(unicode, "\";\n");
              });
              output += "    }\n  </style>\n`;\n\ndocument.head.appendChild($_documentContainer.content);\n";
              fs.writeFile('font-icons.js', output, function (err) {
                if (err) {
                  return console.error(err);
                }
              });
              var list = glyphs.map(function (g) {
                return g.name;
              });
              fs.writeFile('test/glyphs.json', JSON.stringify(list, null, 2), function (err) {
                if (err) {
                  return console.error(err);
                }
              }); // Cleanup

              fs.unlink('lumo-icons.woff', function (err) {
                if (err) {
                  return console.error(err);
                }
              });
            });
          });

        case 2:
        case "end":
          return _context.stop();
      }
    }
  }, _callee);
})));