import{html as e,css as t}from"../../lit-element/lit-element.js";import{SimpleColors as o}from"../simple-colors/simple-colors.js";import{UndoManagerBehaviors as i}from"../undo-manager/undo-manager.js";import{HAXStore as a}from"./lib/hax-store.js";import{autorun as n,toJS as s}from"../../mobx/dist/mobx.esm.js";import{encapScript as r,wipeSlot as l,generateResourceID as d,nodeToHaxElement as c,haxElementToNode as h,camelToDash as u,wrap as m,unwrap as p,ReplaceWithPolyfill as g,normalizeEventPath as v}from"../utils/utils.js";import{HaxUiBaseStyles as b}from"./lib/hax-ui-styles.js";import{I18NMixin as x}from"../i18n-manager/lib/I18NMixin.js";import"../absolute-position-behavior/absolute-position-behavior.js";Element.prototype.replaceWith||(Element.prototype.replaceWith=g),CharacterData.prototype.replaceWith||(CharacterData.prototype.replaceWith=g),DocumentType.prototype.replaceWith||(DocumentType.prototype.replaceWith=g),String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){return this.split(e).join(t)});var y=null;class HaxBody extends(x(i(o))){static get tag(){return"hax-body"}static get styles(){return[...super.styles,t`
        :host([edit-mode]),
        :host([edit-mode]) * ::slotted(*) {
          line-height: 1.8;
        }
        :host([edit-mode]) ul,
        :host([edit-mode]) ol {
          padding-left: 20px;
          margin-left: 20px;
        }
        :host([edit-mode]) ul {
          list-style-type: disc;
        }
        :host([edit-mode]) li {
          margin-bottom: 6px;
        }
        :host {
          display: block;
          position: relative;
          min-height: 32px;
          min-width: 32px;
          outline: none;
          --hax-contextual-action-text-color: var(--hax-ui-background-color);
          --hax-contextual-action-hover-color: var(--hax-ui-color-accent);
          --hax-contextual-action-color: var(--hax-ui-color-accent-secondary);
          --hax-body-editable-outline: 0px solid
            var(--hax-ui-background-color-secondary);
          --hax-body-active-outline-hover: 1px solid
            var(---hax-ui-background-color-faded);
          --hax-body-active-outline: 0px solid var(---hax-ui-color-accent);
          --hax-body-active-drag-outline: 1px solid var(--hax-ui-color-accent);
          --hax-body-target-background-color: var(
            --hax-ui-background-color-accent
          );
          --hax-body-possible-target-background-color: inherit;
        }
        #topcontext {
          z-index: var(--hax-ui-focus-z-index);
        }
        #topcontextmenu {
          display: flex;
          width: 100%;
          align-items: flex-end;
          justify-content: space-between;
          z-index: var(--hax-ui-focus-z-index);
          position: absolute;
          bottom: 0;
        }
        #textcontextmenu,
        #cecontextmenu {
          max-width: 280px;
          flex: 1 1 auto;
        }
        #platecontextmenu {
          flex: 0 0 auto;
        }
        .hax-context-menu {
          visibility: hidden;
          opacity: 0;
          z-index: 1000;
          pointer-events: none;
          transition: 0.2s top ease-in-out, 0.2s left ease-in-out;
        }
        .hax-context-menu:hover,
        .hax-context-menu:focus-within {
          z-index: var(--hax-ui-focus-z-index);
        }
        .hax-context-visible {
          visibility: visible;
          pointer-events: all;
          opacity: 1;
        }
        .hax-context-menu-active {
          opacity: 1;
        }
        :host([edit-mode]) #bodycontainer ::slotted([contenteditable]) {
          -webkit-appearance: textfield;
          cursor: text;
          -moz-user-select: text;
          -khtml-user-select: text;
          -webkit-user-select: text;
          -o-user-select: text;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:empty)::before {
          content: attr(data-hax-ray);
          opacity: 0.2;
          transition: 0.2s all ease-in-out;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:hover:empty)::before {
          opacity: 0.4;
          cursor: text;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:empty:focus)::before {
          content: "";
        }
        :host([edit-mode]) #bodycontainer ::slotted(p) {
          min-height: var(--hax-base-styles-p-min-height, 1rem);
          font-size: var(--hax-base-styles-p-font-size);
          line-height: var(--hax-base-styles-p-line-height);
          letter-spacing: var(--hax-base-styles-p-letter-spacing);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a) {
          color: var(--hax-base-styles-a-color);
          font-size: var(
            --hax-base-styles-a-font-size,
            var(--hax-base-styles-p-font-size)
          );
          font-weight: var(--hax-base-styles-a-font-weight);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:visited) {
          color: var(--hax-base-styles-a-color-visited);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:active),
        :host([edit-mode]) #bodycontainer ::slotted(a:focus),
        :host([edit-mode]) #bodycontainer ::slotted(a:hover) {
          color: var(--hax-base-styles-a-color-active);
          font-weight: var(--hax-base-styles-a-font-weight-active);
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol),
        :host([edit-mode]) #bodycontainer ::slotted(ul),
        :host([edit-mode]) #bodycontainer ::slotted(li) {
          padding-bottom: var(--hax-base-styles-list-padding-bottom);
          line-height: var(
            --hax-base-styles-list-line-height,
            var(--hax-base-styles-p-line-height)
          );
          font-size: var(
            --hax-base-styles-list-font-size,
            var(--hax-base-styles-p-font-size)
          );
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol > li:last-child),
        :host([edit-mode]) #bodycontainer ::slotted(ul > li:last-child) {
          padding-bottom: var(--hax-base-styles-list-last-child-padding-bottom);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img[contenteditable]) {
          max-width: 100%;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          outline: none;
          caret-color: auto;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*.blinkfocus) {
          outline: 4px solid var(--hax-contextual-action-hover-color);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not([data-hax-layout])[contenteditable]:hover) {
          outline: var(--hax-body-active-outline-hover);
          caret-color: auto;
        }
        :host(.hax-add-content-visible[edit-mode])
          #bodycontainer
          ::slotted(*.hax-active) {
          margin-bottom: 30px;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]:hover) {
          cursor: text !important;
          caret-color: auto;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not([data-hax-layout])[contenteditable]
            .hax-active:hover) {
          cursor: text !important;
          caret-color: auto;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(code.hax-active[contenteditable]) {
          display: block;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]) {
          outline: var(--hax-body-active-outline) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(hr[contenteditable]) {
          height: 2px;
          background-color: #eeeeee;
          padding-top: 4px;
          padding-bottom: 4px;
        }
        /** Fix to support safari as it defaults to none */
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          -webkit-user-select: text;
          cursor: pointer;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::-moz-selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::-moz-selection) {
          background-color: var(--hax-body-highlight, #ffffac);
          color: black;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::selection) {
          background-color: var(--hax-body-highlight, #ffffac);
          color: black;
        }
        #bodycontainer {
          -webkit-user-select: text;
          user-select: text;
        }
        absolute-position-behavior:not(:defined),
        .hax-context-menu:not(:defined) {
          display: none;
        }
        /* drag and drop */
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*)::before {
          background-color: var(--hax-body-possible-target-background-color);
          content: " ";
          width: 100%;
          display: block;
          position: relative;
          margin: -12px 0 0 0;
          z-index: 2;
          height: 12px;
          transition: 0.2s all ease-in-out;
        }
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(img) {
          outline: var(--hax-body-editable-outline);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered),
        :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered)::before {
          background-color: var(--hax-body-target-background-color) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered) {
          border-top: 8px
            var(--hax-contextual-action-hover-color, var(--hax-ui-color-accent));
          margin-top: -8px;
        }
        /** This is mobile layout for controls */
        @media screen and (max-width: 800px) {
          #topcontextmenu {
            flex-wrap: wrap-reverse;
          }
          .hax-context-menu {
            height: 0px;
          }
          .hax-context-visible {
            height: auto;
          }
        }

        @media screen and (min-color-index: 0) and(-webkit-min-device-pixel-ratio:0) {
          /*
            Define here the CSS styles applied only to Safari browsers
            (any version and any device) via https://solvit.io/bcf61b6
          */
          :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*) {
            outline: var(--hax-body-editable-outline);
            background-color: var(--hax-body-possible-target-background-color);
          }
          :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered) {
            background-color: var(
              --hax-body-target-background-color
            ) !important;
            outline: var(--hax-body-active-outline);
          }
        }
      `]}constructor(){if(super(),this.__ignoreActive=!1,this.__dragMoving=!1,this.___moveLock=!1,this.editMode=!1,this.haxMover=!1,this.activeNode=null,this.t={addContent:"Add Content"},this.registerLocalization({context:this,namespace:"hax"}),!window.HaxUiStyles){window.HaxUiStyles=document.createElement("div");let e=document.createElement("style"),t=b.map((e=>e.cssText)).join("");e.setAttribute("data-hax",!0),e.setAttribute("type","text/css"),e.styleSheet?e.styleSheet.cssText=t:e.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(e)}setTimeout((()=>{import("./lib/hax-context-behaviors.js"),import("./lib/hax-ce-context.js"),import("./lib/hax-text-context.js"),import("./lib/hax-plate-context.js"),import("../grid-plate/grid-plate.js"),this.polyfillSafe=a.computePolyfillSafe(),this.addEventListener("place-holder-replace",this.replacePlaceholder.bind(this)),this.addEventListener("focusin",this._focusIn.bind(this)),this.addEventListener("mousemove",this._mouseMove.bind(this)),this.addEventListener("mouseleave",this._mouseLeave.bind(this)),this.addEventListener("touchstart",this._mouseMove.bind(this),{passive:!0}),this.addEventListener("mousedown",this._mouseDown.bind(this)),this.addEventListener("mouseup",this._mouseUp.bind(this)),this.addEventListener("dragenter",this.dragEnterBody.bind(this)),this.addEventListener("dragend",this.dragEndBody.bind(this)),this.addEventListener("drop",this.dropEvent.bind(this))}),0),n((()=>{this.editMode=s(a.editMode)})),n((()=>{this.activeNode=s(a.activeNode)})),n((()=>{s(a.activeEditingElement)}))}dragEndBody(e){this.__manageFakeEndCap(!1),a._lockContextPosition=!1,this.querySelectorAll(".hax-hovered").forEach((e=>{e.classList.remove("hax-hovered")}))}_mouseLeave(e){this.editMode&&a.ready&&(clearTimeout(this.__mouseQuickTimer),clearTimeout(this.__mouseTimer),this.__activeHover=null)}_mouseMove(e){}_mouseDown(e){if(this.editMode){this.__mouseDown=!0;let t=e.target;t.closest("[draggable]")?t=t.closest("[draggable]"):t.closest("[slot]")?t=t.closest("[slot]"):t.closest("[data-hax-ray]")?t=t.closest("[data-hax-ray]"):t.closest("[contenteditable]")?t=t.closest("[contenteditable]"):a.validTagList.includes(t.tagName.toLowerCase())||"HAX-BODY"===t.tagName||t.haxUIElement||console.warn(t),!t.haxUIElement&&this.__focusLogic(t)&&(e.stopPropagation(),e.stopImmediatePropagation())}}_mouseUp(e){setTimeout((()=>{this.__mouseDown=!1}),0),clearTimeout(y),this.__manageFakeEndCap(!1)}clickEvent(e){clearTimeout(y)}blurEvent(e){this.editMode&&a.activeEditingElement}__manageFakeEndCap(e=!0){if(e&&!this.__fakeEndCap){let e=document.createElement("fake-hax-body-end");e.style.width="100%",e.style.height="20px",e.style.zIndex="2",e.style.display="block",this.__fakeEndCap=e,this.haxMover=!0,this.appendChild(this.__fakeEndCap),this.__applyNodeEditableState(this.__fakeEndCap,!0)}else!e&&this.__fakeEndCap&&(this.__fakeEndCap.remove(),this.haxMover=!1,this.__fakeEndCap=null)}dragEnterBody(e){this.__manageFakeEndCap(!0)}render(){return e`
      <div id="bodycontainer" class="ignore-activation">
        <slot id="body"></slot>
      </div>
      <absolute-position-behavior
        id="topcontext"
        auto
        justify
        position="top"
        .target="${this.activeNode||document.body}"
      >
        <div id="topcontextmenu">
          <hax-text-context
            id="textcontextmenu"
            class="hax-context-menu ignore-activation"
            .activeNode="${this.activeNode}"
          ></hax-text-context>
          <hax-ce-context
            id="cecontextmenu"
            class="hax-context-menu ignore-activation"
            .activeNode="${this.activeNode}"
          ></hax-ce-context>
          <hax-plate-context
            id="platecontextmenu"
            class="hax-context-menu ignore-activation"
          ></hax-plate-context>
        </div>
      </absolute-position-behavior>
    `}static get properties(){return{...super.properties,haxMover:{type:Boolean,attribute:"hax-mover",reflect:!0},editMode:{type:Boolean,reflect:!0,attribute:"edit-mode"},activeNode:{type:Object}}}firstUpdated(e){this.dispatchEvent(new CustomEvent("hax-register-body",{bubbles:!0,cancelable:!0,composed:!0,detail:this}));try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){console.warn(e)}this.contextMenus={text:this.shadowRoot.querySelector("#textcontextmenu"),plate:this.shadowRoot.querySelector("#platecontextmenu"),ce:this.shadowRoot.querySelector("#cecontextmenu")},this.shadowRoot.querySelector("slot").addEventListener("mouseup",(e=>{this.editMode&&setTimeout((()=>{const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();try{const e=a.getRange();e.cloneRange&&(a._tmpRange=e.cloneRange())}catch(e){console.warn(e)}}),10)})),this.editMode=a.editMode,this.__tabTrap=!1,this.ready=!0,super.firstUpdated&&super.firstUpdated(e)}async updated(e){e.forEach((async(e,t)=>{"editMode"==t&&void 0!==e&&setTimeout((async()=>{this._editModeChanged(this[t],e),this[t]?(await this._activeNodeChanged(this.activeNode,null),this.activeNode.focus()):await this._activeNodeChanged(null,this.activeNode)}),0),"activeNode"==t&&this.ready&&await this._activeNodeChanged(this[t],e)})),super.updated&&super.updated(e)}connectedCallback(){super.connectedCallback(),this._observer=new MutationObserver((e=>{var t=!1;this.__ignoreActive||this.__dragMoving||this.undoStackIgnore||this.__fakeEndCap?this.undoStackIgnore&&e.forEach((e=>{e.addedNodes.length>0&&e.addedNodes.forEach((e=>{this._validElementTest(e)&&setTimeout((()=>{this.__applyNodeEditableState(e,this.editMode)}),0)}))})):e.forEach((e=>{if(e.addedNodes.length>0){for(var o of e.addedNodes)if(this._validElementTest(o)){if(!this.__delHit&&"BR"===o.tagName&&o.parentElement&&a.__validGridTags().includes(o.parentElement.tagName.toLowerCase())&&o===o.parentElement.childNodes[o.parentElement.childNodes.length-1]){let e=o.parentElement;if(o.remove(),e.childNodes.length>0){let t=e.childNodes[e.childNodes.length-1];t.textContent+="​",a._positionCursorInNode(t,t.length)}continue}if(this.__delHit=!1,"P"===o.tagName&&o.children.length>0&&"P"===o.children[0].tagName){p(o);continue}if("P"===o.tagName&&o.parentElement&&"P"===o.parentElement.tagName){p(o.parentElement);continue}if(null!=o.getAttribute("slot")&&o.parentElement===this){o.removeAttribute("slot");continue}if("LI"===o.tagName&&o.children.length>0&&"SPAN"===o.children[0].tagName){this.activeNode!==o.children[0]&&this.activeNode!==o||(this.activeNode=o),p(o.children[0]);continue}if("LI"===o.tagName&&o.parentElement&&!["UL","OL"].includes(o.parentElement.tagName)){p(o);continue}if("P"===o.tagName&&o.children.length>0&&["P","LI"].includes(o.children[0].tagName)){p(o.children[0]);continue}if(this.__slot&&(o.setAttribute("slot",this.__slot),this.__slot=null),this.__indentTrap)if("SPAN"===o.tagName)o.parentNode===this?this.haxChangeTagName(o,"p",!0):"LI"===o.parentNode.tagName&&(o.parentNode.innerHTML=o.textContent);else if("BR"===o.tagName){o.remove();continue}if(!this.editMode||"true"!=o.getAttribute("contenteditable")&&!0!==o.getAttribute("contenteditable")&&"contenteditable"!=o.getAttribute("contenteditable")||this.__applyNodeEditableState(o,!this.editMode),this.__applyNodeEditableState(o,this.editMode),a.isGridPlateElement(o)){let e=o.querySelectorAll("*");for(var i=0;i<e.length;i++)this._validElementTest(e[i])&&this.__applyNodeEditableState(e[i],this.editMode)}if(["H1","H2","H3","H4","H5","H6"].includes(o.tagName)&&null==o.getAttribute("id")&&o.setAttribute("id",d("header-")),this.___moveLock||t)this.___moveLock=!1;else if(t=!0,a.activeNode=o,"BR"===o.tagName){const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();const t=a.getRange();t.collapsed&&"BR"===this.activeNode.tagName&&this.activeNode.parentNode===t.commonAncestorContainer&&""===this.activeNode.innerText&&(a.activeNode=this.activeNode.parentNode)}}this.__indentTrap&&setTimeout((()=>{this.__indentTrap=!1}),0)}else this.ready&&this.editMode&&a.ready&&0===e.addedNodes.length&&e.removedNodes.length>0&&this.shadowRoot&&0===this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}).length&&setTimeout((()=>{0===this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}).length&&this.appendChild(document.createElement("p"))}),100)})),this.__ignoreActive&&(this.__ignoreActive=!1),a.haxTray.updateMap()})),this._observer.observe(this,{childList:!0,subtree:!0}),window.addEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),window.addEventListener("click",this.clickEvent.bind(this)),window.addEventListener("blur",this.blurEvent.bind(this)),window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keypress",this._onKeyPress.bind(this)),document.body.addEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.addEventListener("scroll",this._keepContextVisible.bind(this),{passive:!0}),window.addEventListener("resize",this._keepContextVisible.bind(this),{passive:!0})}disconnectedCallback(){window.removeEventListener("click",this.clickEvent.bind(this)),window.removeEventListener("blur",this.blurEvent.bind(this)),window.removeEventListener("keydown",this._onKeyDown.bind(this)),window.removeEventListener("keypress",this._onKeyPress.bind(this)),document.body.removeEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.removeEventListener("scroll",this._keepContextVisible.bind(this)),window.removeEventListener("resize",this._keepContextVisible.bind(this)),window.removeEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),this._observer.disconnect(),super.disconnectedCallback()}_keepContextVisible(e=null){this.editMode&&(clearTimeout(this.__contextVisibleLock),this.__contextVisibleLock=setTimeout((()=>{let e=!1;this.contextMenus.text.classList.contains("hax-context-visible")?e=this.contextMenus.text:this.contextMenus.ce.classList.contains("hax-context-visible")&&(e=this.contextMenus.ce),e&&(this._setSticky(e),this.positionContextMenus())}),100))}_onKeyDown(e){if(this.editMode&&"HAX-TRAY"!==document.activeElement.tagName&&"BODY"!==document.activeElement.tagName&&"SIMPLE-MODAL"!==document.activeElement.tagName&&this.getAttribute("contenteditable")){if(this.__dropActiveVisible(),this.__manageFakeEndCap(!1),null!=a.getSelection().anchorNode)switch(e.key){case"Z":case"z":e.ctrlKey&&(e.shiftKey?this.redo():this.undo(),e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation());break;case"Tab":a.isTextElement(this.activeNode)&&(e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),e.shiftKey?this._tabBackKeyPressed():this._tabKeyPressed());break;case"Enter":if(this.activeNode&&(this.__slot=this.activeNode.getAttribute("slot")),this.activeNode&&"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const e=this.activeNode.textContent.replaceAll(/ /g," ");this.keyboardShortCutProcess(e)}break;case"Backspace":case"Delete":this.__delHit=!0;break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":setTimeout((()=>{const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();const t=a.getRange();t.commonAncestorContainer&&this.activeNode!==t.commonAncestorContainer&&"function"==typeof t.commonAncestorContainer.focus?"HAX-BODY"!==t.commonAncestorContainer.tagName&&this.__focusLogic(t.commonAncestorContainer,!1):t.commonAncestorContainer&&t.commonAncestorContainer.parentNode&&this.activeNode!==t.commonAncestorContainer.parentNode&&"function"==typeof t.commonAncestorContainer.parentNode.focus&&("HAX-BODY"!==t.commonAncestorContainer.parentNode.tagName?this.__focusLogic(t.commonAncestorContainer.parentNode,!1):this.__focusLogic(t.commonAncestorContainer,!1))}),0);break;default:setTimeout((()=>{if(this.activeNode&&"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const e=this.activeNode.textContent.replaceAll(/ /g," ");" "===e[e.length-1]&&this.keyboardShortCutProcess(e)}}),0)}}}keyboardShortCutProcess(e){if(a.keyboardShortcuts[e.replace(" ","")]){let t=h(a.keyboardShortcuts[e.replace(" ","")]);this.haxReplaceNode(this.activeNode,t),this.__focusLogic(t),"HR"===t.tagName&&this.haxInsert("p","",{})}else if("!"===e[0]){let t=e.replace("!","").replaceAll(/ /g,"");if(a.elementList[t]){let e,o=a.haxSchemaFromTag(t);e=o.gizmo.tag&&o.demoSchema&&o.demoSchema[0]?h(o.demoSchema[0]):document.createElement(t),this.haxReplaceNode(this.activeNode,e),this.__focusLogic(e)}else a.toast(`${t} is not a valid tag`)}}_onKeyPress(e){this.editMode&&this.activeNode&&"Enter"===e.key&&a.isTextElement(this.activeNode)&&(this.activeNode=this.activeNode.nextElementSibling,clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout((()=>{this.__addActiveVisible(),this.positionContextMenus()}),2e3))}elementMidViewport(){const e=this.activeNode.getBoundingClientRect().y;return e<0&&e>-1*this.activeNode.offsetHeight+140}replacePlaceholder(e){if("text"===e.detail){let e=document.createElement("p");this.haxReplaceNode(this.activeNode,e),this.__focusLogic(e),this.activeNode.parentNode&&this.activeNode.parentNode.setAttribute("contenteditable",!0)}else this.replaceElementWorkflow()}async canTansformNode(e=null){return await this.replaceElementWorkflow(e,!0).length>0}async insertElementWorkflow(e=null,t=!1){}async replaceElementWorkflow(e=null,t=!1){null==e&&(e=this.activeNode);let o=await c(e,null),i="*",n=!1;"place-holder"===o.tag&&void 0!==o.properties.type&&(i=o.properties.type,n=!0);var s={};if(void 0!==a.elementList[o.tag]&&!1!==a.elementList[o.tag].gizmo&&void 0!==a.elementList[o.tag].gizmo.handles&&a.elementList[o.tag].gizmo.handles.length>0){let e=a.elementList[o.tag].gizmo;for(var r=0;r<e.handles.length;r++)for(var l in e.handles[r])"type"!==l&&void 0!==o.properties[e.handles[r][l]]&&(s[l]=o.properties[e.handles[r][l]])}let d=a.guessGizmo(i,s,n);if(d.length>0){let o=e.tagName.toLowerCase(),i=o.replace("-"," ");void 0!==a.elementList[o]&&!1!==a.elementList[o].gizmo&&(i=a.elementList[o].gizmo.title),t||(a.activePlaceHolder=this.activeNode,a.haxAppPicker.presentOptions(d,"__convert",`Change ${i} to...`,"gizmo"))}else t||a.toast("Sorry, this can not be transformed!",5e3);return d}_haxStorePropertyUpdated(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&(this[e.detail.property]=e.detail.value)}haxClearBody(e=!0){let t=!0;e&&(t=prompt("Are you sure you want to delete all content?")),t&&l(this)}haxInsert(e,t,o={},i=this.activeNode,n=!1){var s=document.createElement(e);s.innerHTML=t;const r=s.cloneNode(!0);for(var l in o){let e=u(l);o.hasOwnProperty(l)&&(!0===o[l]?r.setAttribute(e,e):!1===o[l]?r.removeAttribute(e):null!=o[l]&&o[l].constructor===Array||null!=o[l]&&o[l].constructor===Object?r.properties&&r.properties[l].readOnly||(r.set?r.set(e,o[l]):r[e]=o[l]):r.setAttribute(e,o[l]))}return null!==a.activePlaceHolder&&void 0!==a.activePlaceHolder.style?(r.style.width=a.activePlaceHolder.style.width,r.style.float=a.activePlaceHolder.style.float,r.style.margin=a.activePlaceHolder.style.margin,r.style.display=a.activePlaceHolder.style.display,this.haxReplaceNode(a.activePlaceHolder,r),a.activePlaceHolder=null):i&&i.parentNode?this.__isLayout(i.parentNode)?(null!=i.getAttribute("slot")&&r.setAttribute("slot",i.getAttribute("slot")),this.__addAbove?i.parentNode.insertBefore(r,i):i.parentNode.insertBefore(r,i.nextElementSibling)):i.parentNode&&i.parentNode.nextElementSibling?i.parentNode.nextElementSibling.parentNode.insertBefore(r,i.parentNode.nextElementSibling):i.parentNode&&i.nextElementSibling?this.__addAbove?i.parentNode.insertBefore(r,i):i.parentNode.insertBefore(r,i.nextElementSibling):i.parentNode&&i.parentNode.children[i.parentNode.children.length-1]===i?this.__addAbove?i.parentNode.insertBefore(r,i):i.parentNode.appendChild(r):i.parentNode?i.parentNode.insertBefore(r,i):this.appendChild(r):this.appendChild(r),this.contextMenus.text.hasSelectedText=!1,setTimeout((()=>{this.__focusLogic(r),this.scrollHere(r)}),0),r}async haxToContent(){this.hideContextMenus();var e=this.activeNode;a.activeNode=null;let t="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];for(var o="",i=0;i<t.length;i++)if(this._validElementTest(t[i]))this.__applyDragDropState(t[i],!1),t[i].classList.remove("hax-hovered"),t[i].contentEditable=!1,o+=await a.nodeToContent(t[i]),this.__isLayout(t[i])&&this._applyContentEditable(this.editMode,t[i]);else if(8===t[i].nodeType)o+="\x3c!-- "+t[i].textContent+" --\x3e";else if(t[i].haxUIElement&&t[i].children&&t[i].children[0]){let e=await a.runHook(t[i],"activeElementChanged",[this.activeNode,!1]);e&&e!==t[i]?o+=await a.nodeToContent(e):o+=await a.nodeToContent(t[i].children[0])}else 1!==t[i].nodeType&&void 0!==t[i].textContent&&"undefined"!==t[i].textContent?o+=t[i].textContent:console.warn(t[i]);if(o=(o=(o=(o=o.replace(/\scontenteditable=\"false\"/g,"")).replace(/\scontenteditable/g,"")).replace(/\sdraggable/g,"")).replace(/\sdata-hax-ray=\".*?\"/g,""),this.parentNode.tagName){let e=this.parentNode.tagName.toLowerCase(),t="style-scope "+e+" x-scope",n=new RegExp(t,"g");o=o.replace(n,""),t="style-scope "+e,n=new RegExp(t,"g"),o=o.replace(n,""),t="x-scope "+e+"-0",n=new RegExp(t,"g"),o=o.replace(n,"");let s=a.validTagList;for(var i in s)t="style-scope "+s[i],n=new RegExp(t,"g"),o=o.replace(n,""),t="x-scope "+s[i]+"-0 ",n=new RegExp(t,"g"),o=o.replace(n,""),t="x-scope "+s[i]+"-0",n=new RegExp(t,"g"),o=o.replace(n,"")}return o=(o=o.replace(/\sclass=\"\"/g,"")).replace(/\sclass=\"\s\"/g,""),this._applyContentEditable(this.editMode),a.activeNode=e,o=r(o)}async haxDuplicateNode(e){let t=await c(e,null);var o=a.elementList[e.tagName.toLowerCase()];if(a.testHook(e,"preProcessInsertContent")&&(t=await a.runHook(e,"preProcessInsertContent",[t])),void 0!==o&&void 0!==o.saveOptions.unsetAttributes)for(var i in o.saveOptions.unsetAttributes)t.properties[o.saveOptions.unsetAttributes[i]]&&delete t.properties[o.saveOptions.unsetAttributes[i]];t.content==t.properties.innerHTML&&delete t.properties.innerHTML;var n=h({tag:t.tag,content:t.content,properties:t.properties});return"webview"===n.tagName.toLowerCase()&&a._isSandboxed&&void 0!==n.guestinstance&&delete n.guestinstance,null!==e?e.parentNode.insertBefore(n,e.nextSibling):e.parentNode.appendChild(n),a.activeNode=n,!0}hideContextMenus(e=!0){clearTimeout(y),clearTimeout(this.__contextVisibleLock),clearTimeout(this.__positionContextTimer),this._hideContextMenu(this.contextMenus.text),this._hideContextMenu(this.contextMenus.ce),this.__activeHover=null,e&&this._hideContextMenu(this.contextMenus.plate)}positionContextMenus(e=this.activeNode){if(e&&e.tagName&&this.ready){let t=e.tagName.toLowerCase();a.elementList&&a.elementList[t]&&a.elementList[t].contentEditable?e.setAttribute("contenteditable",!0):e.removeAttribute("contenteditable"),clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout((()=>{if(!a._lockContextPosition){let t=e.tagName.toLowerCase();a._isSandboxed&&"webview"===t&&(t="iframe");let o=a.elementList[t];void 0===o||a.isTextElement(e)?(this._hideContextMenu(this.contextMenus.ce),this._showContextMenu(this.contextMenus.text)):(this._hideContextMenu(this.contextMenus.text),o.element=e,"core"==o.editingElement?this._showContextMenu(this.contextMenus.ce):this._hideContextMenu(this.contextMenus.ce)),o&&"core"!=o.editingElement?setTimeout((()=>{e&&e.parentNode&&this._showContextMenu(this.contextMenus.plate)}),250):this.activeNode&&("LI"===this.activeNode.tagName||this._HTMLInlineTextDecorationTest(this.activeNode))?this._hideContextMenu(this.contextMenus.plate):this._showContextMenu(this.contextMenus.plate)}this.shadowRoot.querySelector("#topcontext").updatePosition()}),50)}}__addActiveVisible(){for(var e in this.contextMenus)("add"!=e||this.__activeHover)&&this.contextMenus[e].classList.add("hax-context-menu-active")}__dropActiveVisible(){for(var e in this.contextMenus)this.contextMenus[e].classList.remove("hax-context-menu-active");this.__activeHover=null}haxMoveGridPlate(e,t=1){this.___moveLock=!0;let o=e?e.parentNode:void 0,i=t>0?e.nextElementSibling:e.previousElementSibling,a=this.__layoutSlots(o)||[],n=e.getAttribute("slot"),s=n?a.indexOf(n):-1,r=a[s+t];!i||n&&i.getAttribute("slot");return!i||n&&n!==i.getAttribute("slot")?r?e.setAttribute("slot",r):e&&o&&o!==this&&(i=t>0?o.nextElementSibling:o,r=o.getAttribute("slot"),i&&(o.parentNode.insertBefore(e,i),r&&e.setAttribute("slot",r))):o.insertBefore(e,t>0?i.nextElementSibling:i),this.scrollHere(e),this.positionContextMenus(e),!0}async haxGridPlateOps(e=!0,t="right",o=this.activeNode){let i=!1;if("GRID-PLATE"===o.tagName){if(e)switch(o.layout){case"1":o.layout="1-1",i=!0;break;case"1-1":o.layout="1-1-1",i=!0;break;case"1-1-1":o.layout="1-1-1-1",i=!0;break;case"1-1-1-1":o.layout="1-1-1-1-1",i=!0;break;case"1-1-1-1-1":o.layout="1-1-1-1-1-1",i=!0}else switch(o.layout){case"1-1":let e;await o.childNodes.forEach((t=>{t.tagName&&(e=t.cloneNode(!0),o.getAttribute("slot")?e.setAttribute("slot",o.getAttribute("slot")):e.removeAttribute("slot"),o.parentNode.insertBefore(e,o))})),a.activeNode=e,setTimeout((()=>{o.remove()}),0),i=!0;break;case"1-1-1":o.layout="1-1",i=!0;break;case"1-1-1-1":o.layout="1-1-1",i=!0;break;case"1-1-1-1-1":o.layout="1-1-1-1",i=!0;break;case"1-1-1-1-1-1":o.layout="1-1-1-1-1",i=!0}if(i){let e=this.contextMenus.plate.shadowRoot.querySelector("#right"),i=this.contextMenus.plate.shadowRoot.querySelector("#rightremove");e.disabled=!1,i.disabled=!1,"1-1-1-1-1-1"==o.layout&&(e.disabled=!0),"left"==t&&o.childNodes.forEach((e=>{if(e.tagName){let t=parseInt(e.getAttribute("slot").replace("col-",""),10)+1;e.setAttribute("slot",`col-${t}`)}}))}}else{let e=document.createElement("grid-plate");e.layout="1-1",e.disableResponsive=!0,o.getAttribute("slot")&&e.setAttribute("slot",o.getAttribute("slot"));let i="2";"right"==t&&(i="1");let a=o.cloneNode(!0);a.setAttribute("slot","col-"+i),e.appendChild(a),o.parentNode.insertBefore(e,o),setTimeout((()=>{o.remove()}),0)}await a.refreshActiveNodeForm()}haxReplaceNode(e,t){try{null==e&&(e=this.__oldActiveNode),!e.replaceWith&&a._tmpRange&&(e=a._tmpRange,a._tmpRange=null),e&&e.getAttribute&&null!=e.getAttribute("slot")&&t.setAttribute("slot",e.getAttribute("slot")),e.replaceWith(t)}catch(e){console.warn(e)}return t}haxChangeTagName(e,t,o=!0){for(var i=document.createElement(t),a=0,n=e.attributes.length;a<n;++a){let t=e.attributes.item(a).nodeName,o=e.attributes.item(a).value;try{i.setAttribute(t,o)}catch(t){console.warn(e.attributes),console.warn(t)}}o&&(i.innerHTML=e.innerHTML.trim()),"ul"==t||"ol"==t?"<br />"==i.innerHTML?i.innerHTML="<li><br /></li>":"ul"!=e.tagName.toLowerCase()&&"ol"!=e.tagName.toLowerCase()&&(i.innerHTML="<li>"+e.innerHTML.trim().replace(/<br\/>/g,"</li>\n<li>").replace(/<br>/g,"</li>\n<li>")+"</li>"):"ul"!=e.tagName.toLowerCase()&&"ol"!=e.tagName.toLowerCase()||(i.innerHTML=i.innerHTML.replace(/<ul>/g,"").replace(/<\/ul>/g,"").replace(/<li><\/li>/g,"").replace(/<li>/g,"").replace(/<\/li>/g,"<br/>"));try{e.replaceWith(i),o&&setTimeout((()=>{let e=i.children;e[0]&&e.tagName?e[0].focus():i.focus()}),10)}catch(t){console.warn(t),console.warn(i),console.warn(e)}return i}haxDeleteNode(e){if(e.previousElementSibling)a.activeNode=e.previousElementSibling;else if(e.nextElementSibling)a.activeNode=e.nextElementSibling;else{this.haxInsert("p","",{});try{var t=document.createRange(),o=a.getSelection();t.setStart(this.activeNode,0),t.collapse(!0),o.removeAllRanges(),o.addRange(t),this.activeNode.focus()}catch(e){console.warn(e)}}try{return e.remove()}catch(e){console.warn(e)}}importContent(e,t=!0){t&&l(this,"*"),setTimeout((()=>{e=r(e);let t=document.createElement("div");for(t.insertAdjacentHTML("beforeend",e);null!==t.firstChild;)if(void 0!==t.firstChild.tagName)if(a._isSandboxed&&"iframe"===t.firstChild.tagName.toLowerCase()){for(var o=document.createElement("webview"),i=0,n=t.firstChild.attributes.length;i<n;++i){var s=t.firstChild.attributes.item(i).nodeName,l=t.firstChild.attributes.item(i).value;"height"!==s&&"width"!==s||o.style[s],o.setAttribute(s,l)}this.appendChild(o)}else this.appendChild(t.firstChild);else t.removeChild(t.firstChild)}),0)}async _haxContextOperation(e){let t=e.detail;switch(t.eventName){case"insert-above-active":if(this.activeNode&&this.activeNode.previousElementSibling)this.haxInsert("p","",{},this.activeNode.previousElementSibling);else{let e=document.createElement("p");this.insertBefore(e,this.activeNode)}break;case"insert-below-active":this.haxInsert("p","",{});break;case"hax-source-view-toggle":if(this.activeNode.__haxSourceView){this.activeNode.__haxSourceView=!1;let e=await a.runHook(a.activeEditingElement,"activeElementChanged",[this.activeNode,!1]),t=a.haxSchemaFromTag(this.activeNode.tagName.toLowerCase());if(this.activeNode&&this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),t.saveOptions&&t.saveOptions.unsetAttributes&&t.saveOptions.unsetAttributes.length)for(var o in t.saveOptions.unsetAttributes)e.removeAttribute(t.saveOptions.unsetAttributes[o]);this.__applyNodeEditableState(e,this.editMode),p(a.activeEditingElement),a.activeEditingElement=null}else this.activeNode.__haxSourceView=!0,a.activeEditingElement=document.createElement("code-editor"),a.activeEditingElement.language="html",a.activeEditingElement.title="",a.activeEditingElement.theme="vs",a.activeEditingElement.fontSize=12,a.activeEditingElement.wordWrap=!0,import("../code-editor/code-editor.js"),this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",this.activeNode.getAttribute("slot")),this.__ignoreActive=!0,this.activeNode.removeAttribute("contenteditable"),this.__applyDragDropState(this.activeNode,!1),this.activeNode.classList.remove("hax-active"),m(this.activeNode,a.activeEditingElement);break;case"hax-full-text-editor-toggle":if(this.activeNode.__haxSourceView){this.activeNode.__haxSourceView=!1;let e=await a.runHook(a.activeEditingElement,"activeElementChanged",[this.activeNode,!1]),t=a.haxSchemaFromTag(this.activeNode.tagName.toLowerCase());if(this.activeNode&&this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),t.saveOptions&&t.saveOptions.unsetAttributes&&t.saveOptions.unsetAttributes.length)for(var o in t.saveOptions.unsetAttributes)e.removeAttribute(t.saveOptions.unsetAttributes[o]);this.__applyNodeEditableState(e,this.editMode),p(a.activeEditingElement),a.activeEditingElement=null}else this.activeNode.__haxSourceView=!0,import("../rich-text-editor/rich-text-editor.js").then((()=>{a.activeEditingElement=document.createElement("rich-text-editor"),a.activeEditingElement.type="rich-text-editor-toolbar-full",this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",this.activeNode.getAttribute("slot")),this.__ignoreActive=!0,this.activeNode.removeAttribute("contenteditable"),this.__applyDragDropState(this.activeNode,!1),this.activeNode.classList.remove("hax-active"),m(this.activeNode,a.activeEditingElement)}));break;case"text-tag":a.activeNode=this.haxChangeTagName(this.activeNode,t.value),this.positionContextMenus();break;case"text-tag-ul":this.contextMenus.text.realSelectedValue="ul",a.activeNode=this.haxChangeTagName(this.activeNode,"ul"),this.positionContextMenus();break;case"text-tag-ol":this.contextMenus.text.realSelectedValue="ol",a.activeNode=this.haxChangeTagName(this.activeNode,"ol"),this.positionContextMenus();break;case"text-align-left":this.activeNode.style.textAlign=null;break;case"hax-transform-node":this.replaceElementWorkflow();break;case"hax-plate-create-right":this.haxGridPlateOps();break;case"hax-plate-remove-right":this.haxGridPlateOps(!1);break;case"hax-plate-duplicate":this.haxDuplicateNode(this.activeNode);break;case"hax-plate-delete":null!=this.activeNode&&this.haxDeleteNode(this.activeNode);break;case"hax-plate-up":this.haxMoveGridPlate(this.activeNode,-1);break;case"hax-plate-down":this.haxMoveGridPlate(this.activeNode)}}_focusIn(e){this.__mouseDown||this.__focusLogic(e.target)&&(e.stopPropagation(),e.stopImmediatePropagation())}__focusLogic(e,t=!0){let o=!1;if(this.editMode&&!this.__tabTrap){let i=e;"SPAN"===i.tagName&&a.isTextElement(i.parentNode)&&""==i.parentNode.getAttribute("slot")&&(i=e.parentNode);let n=null;if(this._validElementTest(i)&&i.parentNode&&i.parentNode.tagName){if("P"===i.parentNode.tagName&&""==i.parentNode.getAttribute("slot"))n=i,o=!0;else{for(;i.parentNode&&i.parentNode.tagName&&"HAX-BODY"!=i.parentNode.tagName;)null===n&&"B"!==i.tagName&&"I"!==i.tagName&&"STRONG"!==i.tagName&&"EM"!==i.tagName&&(n=i),i=i.parentNode;null===n?n=i:a.isGridPlateElement(i)||(n=i)}(this.activeNode&&this.activeNode.parentNode!==i&&!i.classList.contains("ignore-activation")||i.haxUIElement||i.classList.contains("ignore-activation"))&&(o=!0),n.haxUIElement||n.classList.contains("ignore-activation")||(a.activeNode=n,setTimeout((()=>{if(t&&!this.__mouseDown&&a.isTextElement(n))try{var e=document.createRange(),o=a.getSelection();e.setStart(this.activeNode,0),e.collapse(!0),o.removeAllRanges(),o.addRange(e),this.activeNode.focus()}catch(e){console.warn(e)}this.positionContextMenus(n)}),0),o=!0)}}else this.__tabTrap=!1;return o}scrollHere(e){setTimeout((()=>{"function"==typeof e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded(!0):e.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})}),0)}undo(){super.undo(),setTimeout((()=>{let e=this.querySelector(".hax-active");e?(this.__focusLogic(e),this.scrollHere(e)):this.hideContextMenus()}),0)}redo(){super.redo(),setTimeout((()=>{let e=this.querySelector(".hax-active");e?(this.__focusLogic(e),this.scrollHere(e)):this.hideContextMenus()}),0)}async _editModeChanged(e,t){if(void 0!==t){if(this._applyContentEditable(e),e)if(this.children&&this.children[0]&&this.children[0].focus)this.__focusLogic(this.children[0]);else{this.haxInsert("p","",{});try{var o=document.createRange(),i=a.getSelection();o.setStart(this.activeNode,0),o.collapse(!0),i.removeAllRanges(),i.addRange(o),this.activeNode.focus()}catch(e){console.warn(e)}}setTimeout((()=>{this.undoStack.undoStackLimit=50,this.undoStack.undoStackPosition=-1,this.undoStack.commands=[],this.undoStack.changed(),this.undoStackInitialValue=this.innerHTML,this.undoStackPrevValue=this.undoStackInitialValue}),0)}if(0==e){p(a.activeEditingElement),a.activeEditingElement=null,this.removeAttribute("contenteditable"),this.hideContextMenus();let e=this.querySelectorAll("[contenteditable],.hax-active");for(var n=0;n<e.length;n++){let t=e[n];t.removeAttribute("contenteditable"),t.classList.remove("hax-active")}}let s="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];0===s.length&&(s=this.shadowRoot.querySelector("#body").children);for(n=0;n<s.length;n++)await a.runHook(s[n],"editModeChanged",[e])}_haxResolvePreviousElement(e){for(e=e.previousElementSibling;null!=e&&void 0!==e.tagName&&"HAX-"===e.tagName.substring(0,4);)e=e.previousElementSibling;return e}_validElementTest(e){return!(e.haxUIElement||!e.tagName||["TEMPLATE","HAX-BODY","HAX-APP-SEARCH-RESULT","FAKE-HAX-BODY-END"].includes(e.tagName))&&(!this._HTMLInlineTextDecorationTest(e)||"HAX-BODY"==e.parentNode)}_HTMLInlineTextDecorationTest(e){return["span","b","strong","i","em"].includes(e.tagName.toLowerCase())}_HTMLPrimativeTest(e){return null!=e&&void 0!==e.tagName&&-1==e.tagName.indexOf("-")}_applyContentEditable(e,t=this.shadowRoot.querySelector("#body")){let o="slot"===t.localName?t.assignedNodes({flatten:!0}):[];0===o.length&&(o=t.children);for(var i=0;i<o.length;i++)if(this._validElementTest(o[i])&&(!e||!0!==o[i].getAttribute("contenteditable")&&"true"!=o[i].getAttribute("contenteditable")&&"contenteditable"!=o[i].getAttribute("contenteditable"))&&this.__applyNodeEditableState(o[i],e),a.isGridPlateElement(o[i])){let t=o[i].querySelectorAll("*");for(var n=0;n<t.length;n++)this._validElementTest(t[n])&&this.__applyNodeEditableState(t[n],e)}}__layoutDropEvent(e,t){[...t.querySelectorAll(".active")].forEach((e=>{e.classList.remove("active")})),[...t.shadowRoot.querySelectorAll(".active")].forEach((e=>{e.classList.remove("active")}))}__layoutDragEnter(e){e.target.classList.add("active")}__layoutDragLeave(e){e.target.classList.remove("active")}__layoutMonitor(e){var t=v(e);t[0]&&t[0].assignedNodes&&t[0].assignedNodes().length?t[0].parentNode.classList.add("has-nodes"):t[0].parentNode.classList.remove("has-nodes")}__getLayoutOrder(e,t){if(!t.shadowRoot)return!1;let o=e.getAttribute("slot"),i=t.shadowRoot.querySelector(`[slot=${o}]`);return[...t.shadowRoot.querySelectorAll("[data-layout-slotname]")].indexOf(i)||-1}__layoutCanMove(e,t,o){if(!t.shadowRoot)return!1;let i=t.shadowRoot.querySelector(`[slot=${slot}]`),a=[...t.shadowRoot.querySelectorAll("[data-layout-slotname]")],n=(a.indexOf(i)||-1)+(o?-1:1);return n>=a[0]&&n<=a[a.length-1]}__layoutMove(e,t,o){if(!t.shadowRoot)return!1;let i=t.shadowRoot.querySelector(`[slot=${s}]`),a=[...t.shadowRoot.querySelectorAll("[data-layout-slotname]")],n=a.indexOf(i)||-1,s=a[n+(o?-1:1)];s&&e.setAttribute("slot",s)}async __sortLayoutChildren(e){e.setAttribute("hax-layour-sorting",!0);try{let t=Array.prototype.reduce.call(e.querySelectorAll("[slot]"),(function(e,t){return e}),[]);t=t.sort((function(t,o){return this.__getLayoutOrder(t,e)<this.__getLayoutOrder(o,e)?-1:1})),await t.forEach((t=>{t.parentNode===this&&e.appendChild(t)}))}catch(e){console.warn(e)}e.removeAttribute("hax-layour-sorting")}__layoutSlotValid(e,t){return this.__layoutSlots(t).includes(e.getAttribute("slot"))}__layoutSlots(e){return e.shadowRoot?[...e.shadowRoot.querySelectorAll("[data-layout-slotname]")].map((e=>e.getAttribute("data-layout-slotname"))):[]}__applyDragDropState(e,t){let o={drop:t=>this.__layoutDropEvent(t,e).bind(this),dragenter:this.__layoutDragEnter.bind(this),dragleave:this.__layoutDragEnter.bind(this),slotchange:this.__layoutMonitor.bind(this)};if(e.setAttribute("data-hax-layout",!0),t&&e.setAttribute("data-hax-ray",t),t&&e.shadowRoot){e.addEventListener("drop",o.drop);let t=[...e.shadowRoot.querySelectorAll("drag-enabled")],i=[...e.shadowRoot.querySelectorAll("slot")];t.forEach((e=>{e.addEventListener("dragenter",o.dragenter),e.addEventListener("dragleave",o.dragleave)})),i.forEach((e=>e.addEventListener("slotchange",o.slotchange))),e.haxLayoutObserver=new MutationObserver((t=>{e.getAttribute("hax-layour-sorting")||(t.forEach((t=>{t.addedNodes.forEach((t=>{t.tagName&&t!==this&&t.parentElement&&"HAX-BODY"!==t.parentElement.tagName&&!this.__layoutSlotValid(t,e)&&this.__layoutSlots(e).length>0&&t.setAttribute("slot",this.__layoutSlots(e)[0])}))})),this.__sortLayoutChildren(e))})),e.haxLayoutObserver.observe(this,{childList:!0})}else if(e.shadowRoot){e.haxLayoutObserver&&e.haxLayoutObserver.disconnect(),this.removeEventListener("drop",o.drop);let t=[...e.shadowRoot.querySelectorAll("drag-enabled")],i=[...e.shadowRoot.querySelectorAll("slot")];t.forEach((e=>{e.removeEventListener("dragenter",o.dragenter),e.removeEventListener("dragleave",o.dragleave)})),i.forEach((e=>e.removeEventListener("slotchange",o.slotchange))),e.removeAttribute("data-hax-ray")}}__isLayout(e){return e&&a.isGridPlateElement(e)}__applyNodeEditableState(e,t=!0){let o;if(!e.tagName)return!1;let i=e.tagName.replace("-"," ").toLowerCase(),n=s(a.gizmoList).findIndex((t=>{if(t)return t.tag===e.tagName.toLowerCase()}));if(-1!==n&&(i=s(a.gizmoList)[n].title),"IMG"==e.tagName&&e.setAttribute("draggable",!1),t?(this.__applyDragDropState(e,i),o="addEventListener"):(this.__applyDragDropState(e,!1),o="removeEventListener"),e[o]("drop",this.dropEvent.bind(this)),e[o]("dragenter",this.dragEnter.bind(this)),e[o]("dragleave",this.dragLeave.bind(this)),e[o]("dragover",(e=>{this.__dragMoving=!0,e.preventDefault()})),this._HTMLPrimativeTest(e)&&(t?e.setAttribute("contenteditable",t):e.removeAttribute("contenteditable"),e.querySelectorAll("a").length>0)){let i=e.querySelectorAll("a");for(var r=0,l=i.length;r<l;r++)t?i[r].setAttribute("contenteditable",t):i[r].removeAttribute("contenteditable"),i[r][o]("click",(e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}))}}undoManagerStackLogic(e){this.__dragMoving||(this.querySelectorAll(".hax-hovered").forEach((e=>{e.classList.remove("hax-hovered")})),super.undoManagerStackLogic(e))}dropEvent(e){if(this.editMode){this.__dragMoving=!1,this.undoManagerStackLogic({}),clearTimeout(y),a._lockContextPosition=!1,a.haxTray.activeTab="item-1";var t,o=null,i=v(e);o=e.target.closest("[data-hax-layout]")&&e.target.parentNode!=e.target.closest("[data-hax-layout]")?e.target.closest("[data-hax-layout]"):e.target.closest("[contenteditable],img")?e.target.closest("[contenteditable],img"):e.originalTarget?e.originalTarget:e.target,i[0].classList.contains("column")?this.__slot=i[0].getAttribute("id").replace("col","col-"):o.getAttribute("slot")&&(this.__slot=o.getAttribute("slot")),a.activeNode=o,this.querySelectorAll(".hax-hovered").forEach((e=>{e.classList.remove("hax-hovered")})),this.querySelectorAll(".active").forEach((e=>{e.classList.remove("active")}));try{if(e.dataTransfer&&e.dataTransfer.items&&e.dataTransfer.items.length>0&&"file"===e.dataTransfer.items[0].kind){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();let o=document.createElement("p");e.target.closest("[data-hax-layout]")&&e.target.parentNode!=e.target.closest("[data-hax-layout]")?t=e.target.closest("[data-hax-layout]"):e.target.closest("[contenteditable],img")&&(t=e.target.closest("[contenteditable],img")),t&&(t.tagName&&"HAX-BODY"!==t.tagName||!t.getAttribute("data-hax-layout"))||this.__isLayout(i[0])?(t.getAttribute("slot")?o.setAttribute("slot",t.getAttribute("slot")):i[0].classList.contains("column")?o.setAttribute("slot",i[0].getAttribute("id").replace("col","col-")):o.removeAttribute("slot"),t.parentNode.insertBefore(o,t)):(i[0].classList.contains("column")?o.setAttribute("slot",i[0].getAttribute("id").replace("col","col-")):t&&"HAX-BODY"===t.tagName&&o.getAttribute("slot")&&o.removeAttribute("slot"),t?t.appendChild(o):this.appendChild(o)),e.placeHolderElement=o,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e}))}else{if(o=a.__dragTarget,t=e.target,e.target.closest("[data-hax-layout]")&&e.target.parentNode!=e.target.closest("[data-hax-layout]")?t=e.target.closest("[data-hax-layout]"):e.target.closest("[contenteditable],img")&&(t=e.target.closest("[contenteditable],img")),t&&o&&this._validElementTest(o)&&o!==t){try{"HAX-BODY"!==t.tagName&&!this.__isLayout(t)||this.__isLayout(i[0])?(t.getAttribute("slot")?o.setAttribute("slot",t.getAttribute("slot")):i[0].classList.contains("column")?o.setAttribute("slot",i[0].getAttribute("id").replace("col","col-")):o.removeAttribute("slot"),t.parentNode.insertBefore(o,t)):(i[0].classList.contains("column")?o.setAttribute("slot",i[0].getAttribute("id").replace("col","col-")):"HAX-BODY"===t.tagName&&o.getAttribute("slot")&&o.removeAttribute("slot"),t.appendChild(o))}catch(e){console.warn(e)}e.preventDefault(),e.stopPropagation()}o&&this._validElementTest(o)&&"function"==typeof o.focus&&(a.activeNode=o,this.dispatchEvent(new CustomEvent("hax-drop-focus-event",{bubbles:!0,cancelable:!0,composed:!0,detail:this.activeNode})),this.scrollHere(this.activeNode),this.positionContextMenus())}}catch(e){console.warn(e)}}a.__dragTarget=null,this.__manageFakeEndCap(!1)}dragEnter(e){this.editMode&&e.target&&a.__dragTarget&&(this.__dragMoving=!0,e.preventDefault(),e.target&&e.target.classList&&e.target.classList.add("hax-hovered"),this.handleMousemove(e))}handleMousemove(e){var t=e.clientX,o=e.clientY,i=document.documentElement.clientWidth,a=document.documentElement.clientHeight,n=a-200,s=i-200,r=t<200,l=t>s,d=o<200,c=o>n;if(r||l||d||c){var h=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.body.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth),u=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.body.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight),m=h-i,p=u-a;!function checkForWindowScroll(){clearTimeout(y),function adjustWindowScroll(){var e=window.pageXOffset,i=window.pageYOffset,a=i>0,h=i<p,u=e>0,g=e<m,v=e,b=i;if(r&&u){v-=25*((200-t)/200)}else if(l&&g){v+=25*((t-s)/200)}if(d&&a){b-=25*((200-o)/200)}else if(c&&h){b+=25*((o-n)/200)}return v=Math.max(0,Math.min(m,v)),b=Math.max(0,Math.min(p,b)),(v!==e||b!==i)&&(window.scrollTo(v,b),!0)}()&&(y=setTimeout(checkForWindowScroll,30))}()}else clearTimeout(y)}dragLeave(e){this.editMode&&e.target&&e.target.classList&&(this.__dragMoving=!0,e.target.classList.remove("hax-hovered"))}async _activeNodeChanged(e,t){if(window.SimplePopoverManager.requestAvailability().opened=!1,await this.querySelectorAll(".hax-active").forEach((e=>{e.classList.remove("hax-active")})),this.editMode&&null!=e&&e.parentNode){let t=e.tagName.toLowerCase();e.classList.add("hax-active"),a.isTextElement(e)||"HR"===e.tagName||a.isGridPlateElement(e)?(e.setAttribute("contenteditable",!0),this.setAttribute("contenteditable",!0)):(e.removeAttribute("contenteditable"),this.removeAttribute("contenteditable")),this._keepContextVisible(),this.contextMenus.text.realSelectedValue=t}else null===e&&(this.hideContextMenus(),this.__oldActiveNode=t);if(this.editMode&&await a.runHook(t,"activeElementChanged",[t,!1])&&(this.__ignoreActive=!0),this.editMode&&await a.runHook(e,"activeElementChanged",[e,!0])&&(this.__ignoreActive=!0),this.editMode&&t){let e=a.haxSchemaFromTag(t.tagName.toLowerCase());if("core"!=e.editingElement||t.parentNode&&t.parentNode.haxUIElement&&t.parentNode===a.activeEditingElement){this.__ignoreActive=!0;let i=await a.runHook(a.activeEditingElement,"activeElementChanged",[t,!1]);if(i&&i!==t){if(t&&t.getAttribute&&null!=t.getAttribute("slot")&&i.setAttribute("slot",t.getAttribute("slot")),e.saveOptions&&e.saveOptions.unsetAttributes&&e.saveOptions.unsetAttributes.length)for(var o in e.saveOptions.unsetAttributes)i.removeAttribute(e.saveOptions.unsetAttributes[o]);this.__applyNodeEditableState(i,this.editMode)}p(a.activeEditingElement),a.activeEditingElement=null}}if(this.editMode&&e){let t=a.haxSchemaFromTag(e.tagName);if(t&&t.editingElement&&"core"!=t.editingElement){if(t.editingElement.import){let e=a.pathFromUrl(decodeURIComponent(import.meta.url));await import(`${e}../../${t.editingElement.import}`)}a.activeEditingElement=document.createElement(t.editingElement.tag),e.getAttribute&&null!=e.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",e.getAttribute("slot")),t.editingElement.callback&&t.editingElement.callback(a.activeEditingElement),this.__ignoreActive=!0,m(e,a.activeEditingElement),await a.runHook(a.activeEditingElement,"activeElementChanged",[e,!0])}}}_getPosition(e){return{x:e.offsetLeft-e.scrollLeft+e.clientLeft,y:e.offsetTop-e.scrollTop+e.clientTop}}_showContextMenu(e){e.setAttribute("on-screen","on-screen"),e.classList.add("hax-context-visible","hax-context-menu-active")}_getContextContainer(e){let t=e&&e.parentNode?e.parentNode:void 0;return t&&t.nodeType?1==t.nodeType?t:t.host:void 0}_setSticky(e,t=!0){if(!e||!this._getContextContainer(e))return;let o=this._getContextContainer(e),i=t&&this.activeNode&&this.elementMidViewport();o.menuSticky=i}_hideContextMenu(e){if(!e)return;let t=this._getContextContainer(e);e.removeAttribute("on-screen"),e.visible=!1,e.classList.remove("hax-context-visible","hax-context-menu-active"),this._setSticky(e),t&&(t.menusVisible=!1)}_tabKeyPressed(){if(this.activeNode&&a.getRange().cloneRange)try{let t=!1,o=this.activeNode.parentNode;const i=this.activeNode.parentNode.tagName;let n=a.getRange().cloneRange();var e=n.commonAncestorContainer.tagName;if(void 0===e&&(e=n.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(i)||["UL","OL","LI"].includes(e))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("indent"));else for(;!t;)null==o.nextSibling?t=!0:"function"===o.nextSibling.focus?(o.nextSibling.focus(),t=!0):o=o.nextSibling}catch(e){console.warn(e)}}_tabBackKeyPressed(){if(this.activeNode&&a.getRange().cloneRange)try{let t=this.activeNode.parentNode;const o=this.activeNode.parentNode.tagName;let i=a.getRange().cloneRange();var e=i.commonAncestorContainer.tagName;if(void 0===e&&(e=i.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(o)||["UL","OL","LI"].includes(e))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("outdent"));else{if(null!=t)for(;null!=t&&!this._validElementTest(t);)t=t.previousSibling;null!=t&&setTimeout((()=>{t.focus()}),50)}}catch(e){console.warn(e)}}}window.customElements.define(HaxBody.tag,HaxBody);export{HaxBody};