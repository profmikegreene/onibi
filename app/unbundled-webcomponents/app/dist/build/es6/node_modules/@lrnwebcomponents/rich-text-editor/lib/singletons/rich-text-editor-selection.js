/**
 * Copyright 2019 Penn State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as e,html as t,css as i}from"../../../../lit-element/lit-element.js";import{normalizeEventPath as o}from"../../../utils/utils.js";class RichTextEditorSelection extends e{get validCommands(){return["backColor","bold","copy","createLink","cut","decreaseFontSize","defaultParagraphSeparator","delete","fontName","fontSize","foreColor","formatBlock","forwardDelete","hiliteColor","increaseFontSize","indent","insertBrOnReturn","insertHorizontalRule","insertHTML","insertImage","insertLineBreak","insertOrderedList","insertUnorderedList","insertParagraph","insertText","italic","justifyCenter","justifyFull","justifyLeft","justifyRight","outdent","paste","redo","removeFormat","selectAll","strikethrough","styleWithCss","subscript","superscript","undo","unlink","useCSS"]}constructor(){super();this.hidden=!0,this.__toolbars=[],this.__clipboard=document.createElement("textarea"),this.__clipboard.setAttribute("aria-hidden",!0),this.__clipboard.style.position="absolute",this.__clipboard.style.left="-9999px",this.__clipboard.style.top="0px",this.__clipboard.style.width="0px",this.__clipboard.style.height="0px",this.id=this._generateUUID(),document.body.appendChild(this.__clipboard),window.addEventListener("register",this._handleRegistration.bind(this))}render(){return t`<slot></slot>`}updated(e){super.updated(e),e.forEach(((e,t)=>{}))}disconnectedCallback(){super.disconnectedCallback()}cancelEdits(e){e.revert(),this.edit(e,!1)}closeToolbar(e,t=e.editor){t&&this.disableEditing(t),e.editor=void 0,document.body.append(e)}disableEditing(e){e&&(this.getRoot(e).onselectionchange=void 0,e.viewSource=!1,e.disableEditing(),e.makeSticky(!1))}edit(e,t=!0){if(e){let i=e?this.getConnectedToolbar(e):void 0,o=t?i.editor:void 0;this.highlight(i,!1),i&&o!==e&&(o&&this.disableEditing(o),i.editor=e,this.enableEditing(e,i))}}enableEditing(e,t=this.getConnectedToolbar(e)){e&&(e.makeSticky(t.sticky),e.parentNode.insertBefore(t,e),e.enableEditing(),this.updateRange(e),this.getRoot(e).onselectionchange=i=>{t.__promptOpen||this.updateRange(e)})}expandRangeTo(e="",t){let i=t?this.getRangeNode(t):void 0,o=i&&i.tagName?i.tagName.toLowerCase():void 0;return e.toLowerCase().replace(/\s*/g,"").split(",").includes(o)?i:i.closest(e)?(t.selectNode(i.closest(e)),t):void 0}getRangeNode(e){let t=e?e.commonAncestorContainer:void 0,i=e?e.startContainer:void 0,o=e?e.startOffset:void 0,r=e?e.endContainer:void 0,n=e?e.endOffset:void 0,a=i&&i.children?i.children[o-1]:void 0;return i===r&&n-o==1?a:t}getRoot(e){return e&&e!==document?e.parentNode?this.getRoot(e.parentNode):e:document}getConnectedToolbar(e){if(e.id||(e.id=this._generateUUID()),!e.__connectedToolbar){let t,i=e.toolbar?(this.__toolbars||[]).filter((t=>e.toolbar&&t.id===e.toolbar)):[];0===i.length&&(i=e.type?(this.__toolbars||[]).filter((t=>e.type&&t.type===e.type)):[]),0===i.length&&(i=this.__toolbars),i[0]?t=i[0]:0===i.length&&(t=document.createElement(e.type||"rich-text-editor-toolbar"),e.parentNode.insertBefore(t,e)),t.id=t.id||e.toolbar||this._generateUUID(),e.__connectedToolbar=t}return e.__connectedToolbar}highlight(e,t=!0,i){this.toolbar=e,(e?e.editor:void 0)&&(!1!==t?e.range&&(this.hidden=!1,e.range.insertNode(this),i&&this.append(i),e.range.setStartAfter(this),this.range=e.range):(this.updateRange(e.editor,e.range),this.hidden=!0,this.toolbar=void 0,this.range=void 0,document.body.appendChild(this)),this.dispatchEvent(new CustomEvent("change",{bubbles:!0,cancelable:!0,composed:!0,detail:t})))}highlightNode(e,t){this.selectNode(e,t.range,t.editor),this.highlight(t)}pasteFromClipboard(e){setTimeout((async()=>{let t=window.getSelection(),i=e.range,o=await navigator.clipboard.readText();this.__clipboard.value=o,this.__clipboard.focus(),this.__clipboard.select(),document.execCommand("paste"),t.removeAllRanges(),t.addRange(i),this.pasteIntoEditor(e,this.__clipboard.value)}),2e3)}pasteIntoEditor(e,t){if(e){let i=e.range,o=document.createElement("div");if(e=i.commonAncestorContainer.parentNode.closest("[editing=true]:not([disabled]),input:not([disabled]),textarea:not([disabled])")){for(o.innerHTML=e.sanitizeHTML(t),i&&i.extractContents&&i.extractContents(),i.insertNode(o);o.firstChild;)o.parentNode.insertBefore(o.firstChild,o);o.parentNode.removeChild(o)}}}registerEditor(e,t=!1){let i=e?this.getConnectedToolbar(e):void 0,o={click:t=>this._handleEditorClick(e,t),focus:t=>{i.__promptOpen||e.disabled||this.edit(e)},getrange:t=>{i.__promptOpen||(this.toolbar=i,this.updateRange(e,e.range))},keydown:t=>this._handleShortcutKeys(e,t),pastefromclipboard:e=>this.pasteFromClipboard(e.detail),pastecontent:e=>this._handlePaste(e)};return t?Object.keys(o).forEach((t=>e.removeEventListener(t,o[t]))):Object.keys(o).forEach((t=>e.addEventListener(t,o[t]))),(e.__connectedToolbar.show=!e.__connectedToolbar.editor)&&this.edit(e),e.__connectedToolbar}registerToolbar(e,t=!1){let i={command:t=>{t.stopImmediatePropagation();let i=t.detail||{};this._handleCommand(e,i.command,i.commandVal,i.range),i.button&&i.button.commandCallback&&i.button.commandCallback(e.editor,e,this)},disableediting:e=>this.disableEditing((e.detail||{}).editor),highlight:t=>{this.highlight(e,t.detail)},highlightnode:t=>{this.highlightNode(t.detail,e)},pastefromclipboard:e=>{e.stopImmediatePropagation(),this.pasteFromClipboard(e.detail)},"rich-text-editor-prompt-closed":t=>{e.__promptOpen=!1},"rich-text-editor-prompt-open":t=>{e.__promptOpen=!0},setrange:e=>{this.range=(e.detail||{}).range,this.updateRange((e.detail||{}).editor,this.range),this.selectRange(this.range,(e.detail||{}).editor)},selectnode:t=>{this.selectNode(t.detail,e.range,e.editor)},selectnodecontents:t=>{this.selectNodeContents(t.detail,e.range,e.editor)},selectrange:t=>{this.selectRange(t.detail,e.editor)},wrapselection:t=>{this.surroundRange(t.detail,e.range)}};t||e.registered?(e.registered=!1,Object.keys(i).forEach((t=>e.removeEventListener(t,i[t])))):(this.__toolbars.push(e),Object.keys(i).forEach((t=>e.addEventListener(t,i[t]))),e.registered=!0)}selectNode(e,t,i=this.toolbar.editor){if(!t){let e=window.getSelection();t=document.createRange(),e.removeAllRanges(),e.addRange(t)}t&&(t.selectNode(e),i&&this.updateRange(i,t))}selectNodeContents(e,t,i){if(e){if(!t){let e=window.getSelection();t=document.createRange(),e.removeAllRanges(),e.addRange(t)}t&&(t.selectNodeContents(e),i&&this.updateRange(i,t))}}selectRange(e,t=!0,i){if(e){if(t){let t=window.getSelection();t.removeAllRanges(),t.addRange(e)}else e.isCollapsed||e.collapse();i&&this.updateRange(i)}return e}surroundRange(e,t){return t&&(t.surroundContents(e),editor&&this.updateRange(editor)),t}updateRange(e,t){if(e){let i=this.getConnectedToolbar(e);this.toolbar=i,t||(t=e.range),e.range=t,i&&(i.selectedNode=e.selectedNode,i.selectionAncestors=e.selectionAncestors,i.range=t)}}_generateUUID(){let e=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return"rte-"+"ss-s-s-s-sss".replace(/s/g,e)}_handleBlur(e,t){null===t.relatedTarget||"rich-text-editor"===!t.relatedTarget.startsWith?this.edit(e,!0):e&&this.highlight(e.toolbar)}_handleCommand(e,t,i,o){let r=e.editor;this.validCommands.includes(t)?(i=r?r.sanitizeHTML(i):i,this.range=r.range,this.updateRange(r,o),this.selectRange(o,r),"paste"!=t?document.execCommand(t,!1,i):navigator.clipboard&&this.pasteFromClipboard(r),this.highlight(e,!1)):"cancel"===t?(r&&r.revert(),e.close(r)):"close"===t&&e.close(r)}_handleEditorClick(e,t){if(!e||e.disabled)return;let i=this.getConnectedToolbar(e),o=e.__focused;if(i&&i.editor===e||this.edit(e),e.focus(),o){let e=i?Object.keys(i.clickableElements||{}):[],o=t.target||t.srcElement||{tagName:""},r={detail:o},n=(o.tagName||"").toLowerCase();n&&e.includes(n)&&(console.log(o),t.preventDefault(),i.clickableElements[n](r))}}_handleRegistration(e){e.detail&&(e.detail.toolbar&&this.registerToolbar(e.detail.toolbar,e.detail.remove),e.detail.editor&&this.registerEditor(e.detail.editor,e.detail.remove))}_handleShortcutKeys(e,t){let i=e?this.getConnectedToolbar(e):void 0;e.editing&&i._handleShortcutKeys(t)}static get tag(){return"rich-text-editor-selection"}static get properties(){return{editor:{type:Object},collapsed:{type:Boolean,reflect:!0,attribute:"collapsed"},hidden:{type:Boolean,reflect:!0,attribute:"hidden"},id:{type:String,reflect:!0,attribute:"id"},observer:{type:Object},range:{type:Object},toolbar:{type:Object},__toolbars:{type:Array}}}static get styles(){return[i`
        :host {
  background-color: var(--rich-text-editor-selection-bg, rgb(146, 197, 255));
          margin: 0;
          padding: 0;
          display: inline-block;
        }
        :host([hidden]) {
          display: none;
        }
        :host([collapsed]):after {
          content: '|';
          color: var(--simple-toolbar-selection-bg);
          background-color: transparent;
        }
        :host + *,
        ::slotted(*) {
  background-color: var(--rich-text-editor-selection-bg, rgb(146, 197, 255));
        }
      `]}}window.customElements.define(RichTextEditorSelection.tag,RichTextEditorSelection);export{RichTextEditorSelection};window.RichTextEditorSelection={},window.RichTextEditorSelection.instance=null,window.RichTextEditorSelection.requestAvailability=function(){return null==window.RichTextEditorSelection.instance&&(window.RichTextEditorSelection.instance=document.createElement(RichTextEditorSelection.tag),document.body.appendChild(window.RichTextEditorSelection.instance)),window.RichTextEditorSelection.instance};