/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as e,html as t,css as i}from"../../lit-element/lit-element.js";import*as s from"../../shadow-selection-polyfill/shadow.js";import{RichTextStyles as r}from"./lib/buttons/rich-text-editor-button.js";import"./lib/toolbars/rich-text-editor-toolbar.js";import"./lib/toolbars/rich-text-editor-toolbar-mini.js";import"./lib/toolbars/rich-text-editor-toolbar-full.js";import"./lib/singletons/rich-text-editor-selection.js";const RichTextEditorBehaviors=function(e){return class extends e{static get styles(){return[...r,i`
          :host {
            display: block;
          }
          :host([hidden]) {
            display: none;
          }
          :host([disabled]) {
            cursor: not-allowed;
          }
          :host(:empty) {
            opacity: 0.7;
          }
          :host(:focus) {
            outline: none;
          }

          :host(.heightmax[editing]) {
            max-height: calc(100vh - 200px);
            overflow-y: scroll;
          }

          #container,
          #wysiwyg {
            display: block;
            width: 100%;
          }
          #source,
          #wysiwyg {
            margin: 0;
            padding: 0;
            min-height: var(--rich-text-editor-min-height, 20px);
            cursor: pointer;
            outline: none;
            flex: 1 1 100%;
            width: 100%;
          }
          :host(:empty) #wysiwyg::after {
            display: block;
            content: attr(aria-placeholder);
          }

          :host(:hover),
          :host(:focus-within) {
            opacity: 1;
            outline: var(--rich-text-editor-border-width, 1px) solid
              var(--rich-text-editor-focus-color, blue);
          }
          :host([disabled]),
          :host([view-source]) {
            outline: none !important;
          }

          #source:hover,
          #source:focus-within {
            outline: var(--rich-text-editor-border-width, 1px) solid
              var(--rich-text-editor-focus-color, blue);
          }
          :host([editing][view-source]) #container {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            width: 100%;
          }
          :host([editing][view-source]) #source,
          :host([editing][view-source]) #wysiwyg {
            resize: horizontal;
            overflow: auto;
            flex: 1 1 auto;
            width: 50%;
          }
          :host([editing][view-source]) #source {
            min-width: 300px;
          }
          :host([editing][view-source]) #wysiwyg {
            cursor: not-allowed;
            margin-right: 10px;
            width: calc(50% - 10px);
          }
        `]}render(){return t` <div
        id="container"
        @focus="${e=>this.__focused=!0}"
        @blur="${e=>this.__focused=!1}"
        @mouseover="${e=>this.__hovered=!0}"
        @mouseout="${e=>this.__hovered=!1}"
      >
        <div id="wysiwyg" aria-placeholder="${this.placeholder}">
          <slot></slot>
        </div>
        <code-editor
          id="source"
          font-size="13"
          ?hidden="${!(this.viewSource&&this.editing)}"
          language="html"
          @value-changed="${this._handleSourceChange}"
          word-wrap
        >
        </code-editor>
      </div>`}static get properties(){return{...super.properties,id:{name:"id",type:String,reflect:!0,attribute:"id"},editing:{name:"editing",type:Boolean,reflect:!0,attribute:"editing"},disabled:{name:"disabled",type:Boolean,attribute:"disabled",reflect:!0},disableHover:{name:"disableHover",type:Boolean,attribute:"disable-hover"},placeholder:{name:"placeholder",type:String,reflect:!0,attribute:"placeholder"},toolbar:{name:"toolbar",type:String,reflect:!0,attribute:"toolbar"},range:{name:"range",type:Object,attribute:"range"},rawhtml:{type:String,attribute:"rawhtml"},type:{name:"type",type:String,reflect:!0,attribute:"type"},updateRange:{type:Boolean},viewSource:{type:Boolean,attribute:"view-source",reflect:!0},__canceledEdits:{type:Object},__connectedToolbar:{type:Object},__codeEditorValue:{type:String},__needsUpdate:{type:Boolean},__focused:{type:Boolean},__hovered:{type:Boolean},__selection:{type:Object}}}static get tag(){return"rich-text-editor"}constructor(){super(),this.placeholder="Click to edit",this.toolbar="",this.type="rich-text-editor-toolbar",this.id="",this.range=void 0,this.disabled=!1,this.__focused=!1,this.__hovered=!1,this.editing=!1,this.__selection=window.RichTextEditorSelection.requestAvailability();import("../code-editor/code-editor.js"),this.setAttribute("tabindex",1),document.addEventListener(s.eventName,this._getRange.bind(this))}get observer(){return new MutationObserver(this._getRange)}connectedCallback(){super.connectedCallback(),setTimeout((()=>{this.register()}),500)}disconnectedCallback(){super.disconnectedCallback(),this.register(!0)}firstUpdated(){super.firstUpdated&&super.firstUpdated(),this.isEmpty()&&this.rawhtml?this.setHTML(this.rawhtml):(this.isEmpty()&&(this.innerHTML=""),this._editableChange())}updated(e){super.updated(e),e.forEach(((e,t)=>{"editing"===t&&this._editableChange(),"disabled"===t&&(this.disableEditing(),this.setAttribute("tabindex",this.disabled?-1:0)),"range"===t&&this._rangeChange(),"rawhtml"===t&&this.rawhtml&&this.setHTML(this.rawhtml),"viewSource"===t&&this._handleViewSourceChange(),["viewSource","editing"].includes(t)&&(this.editing&&!this.viewSource?this.setAttribute("contenteditable",!0):this.removeAttribute("contentEditable"))})),this.innerHTML||(this.innerHTML="")}disableEditing(){this.editing=!1,this.dispatchEvent(new CustomEvent("editing-disabled",{bubbles:!0,composed:!0,cancelable:!0,detail:(this.innerHTML||"").replace(/<!--[^(-->)]*-->/g,"").trim()}))}enableEditing(){this.editing=!0,this.dispatchEvent(new CustomEvent("editing-enabled",{bubbles:!0,composed:!0,cancelable:!0,detail:(this.innerHTML||"").replace(/<!--[^(-->)]*-->/g,"").trim()}))}focus(){this.disabled||(this.__focused=!0),this.dispatchEvent(new CustomEvent("focus",{bubbles:!0,composed:!0,cancelable:!0,detail:this.querySelector("*")}))}getHTML(){return this.isEmpty()?"":(this.innerHTML||"").replace(/<!--[^(-->)]*-->/g,"").trim()}isEmpty(){return!this.innerHTML||""==this.trimHTML(this)}makeSticky(e=!0){e?this.classList.remove("heightmax"):this.classList.add("heightmax")}observeChanges(e=!0){e?this.observer.observe(this,{attributes:!1,childList:!0,subtree:!0,characterData:!1}):this.observer&&this.observer.disconnect}paste(e,t=!0){this._handlePaste(e)}register(e=!1){window.dispatchEvent(new CustomEvent("register",{bubbles:!0,cancelable:!0,composed:!0,detail:{remove:e,editor:this}}))}revert(){this.innerHTML=this.__canceledEdits}rootNode(){return this.__selection?this.__selection.getRoot(this):document}sanitizeHTML(e){if(!e)return;let t="<body(.*\n)*>(.*\n)*</body>";return e.match(t)&&e.match(t).length>0&&(e=e.match(t)[0].replace(/<\?body(.*\n)*\>/i)),e}setHTML(e=""){let t=this.sanitizeHTML(e).trim();this.innerHTML=t,this.setCancelHTML(t),this.isEmpty()&&(this.innerHTML=""),this._editableChange()}setCancelHTML(e=this.innerHTML){this.__canceledEdits=e||""}trimHTML(e){let t=e?e.innerHTML:void 0;return this.trimString(t)}trimString(e){return(e||"").replace(/<!--[^(-->)]*-->/g,"").replace(/[\s\t\r\n]/gim,"")}updateRange(){this.dispatchEvent(new CustomEvent("getrange",{bubbles:!0,cancelable:!0,composed:!0,detail:this}))}_editableChange(){let keyPress=e=>{if(this.isEmpty()&&e.key){this.innerHTML=e.key.replace(">","&gt;").replace("<","&lt;").replace("&","&amp;");this._getRange();this.range.selectNodeContents(this),this.range.collapse()}};this.editing?(this.addEventListener("keypress",keyPress),this.setCancelHTML()):this.removeEventListener("keypress",keyPress)}_getRange(){let shadowRoot=e=>{let t=e.parentNode;return t?shadowRoot(t):e};try{this.range=shadowRoot(this)?s.getRange(shadowRoot(this)):void 0}catch(e){this.range=void 0}return this.updateRange&&this.updateRange(),this.range}_handlePaste(e){let t="";e&&(e.clipboardData||e.originalEvent.clipboardData)?t=(e.originalEvent||e).clipboardData.getData("text/html"):window.clipboardData&&(t=window.clipboardData.getData("Text")),this.dispatchEvent(new CustomEvent("pastefromclipboard",{bubbles:!0,cancelable:!0,composed:!0,detail:this})),e.preventDefault()}_handleSourceChange(e){if(!this.__needsUpdate){let t=`${this.innerHTML}`,i=e.detail.value?`${e.detail.value}`:t,s=this._outdentHTML(i).replace(/\s+/gm,""),r=this._outdentHTML(t).replace(/\s+/gm,"");this.__needsUpdate=s.localeCompare(r);let update=()=>{this.__needsUpdate=!1,this.innerHTML=e.detail.value};this.__needsUpdate&&setTimeout(update.bind(this),300)}}_outdentHTML(e=""){let t=(e=this.sanitizeHTML(e).replace(/[\s]*$/,"").replace(/^[\n\r]*/,"").replace(/[\n\r]+/gm,"\n")).match(/^\s+/),i=!!t&&t[0],s=!!i&&new RegExp(`\\n${i}`,"gm");return e=e.replace(/^\s+/,""),e=s?e.replace(s,"\n "):e}_handleViewSourceChange(e){let t=this.shadowRoot?this.shadowRoot.querySelector("#source"):void 0;t&&this.viewSource?(t.editorValue=this._outdentHTML(this.innerHTML),t.addEventListener("value-changed",this._handleSourceChange.bind(this))):t&&t.removeEventListener("value-changed",this._handleSourceChange.bind(this))}_rangeChange(e){}}};class RichTextEditor extends(RichTextEditorBehaviors(e)){}window.customElements.define(RichTextEditor.tag,RichTextEditor);export{RichTextEditor,RichTextEditorBehaviors};