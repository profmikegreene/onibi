/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as t}from"../../../lit-element/lit-element.js";window.AbsolutePositionStateManager=window.AbsolutePositionStateManager||{},window.AbsolutePositionStateManager.requestAvailability=()=>{if(!window.AbsolutePositionStateManager.instance){window.AbsolutePositionStateManager.instance=document.createElement("absolute-position-state-manager");let t=window.AbsolutePositionStateManager.instance;document.body.appendChild(t)}return window.AbsolutePositionStateManager.instance};class AbsolutePositionStateManager extends t{static get tag(){return"absolute-position-state-manager"}static get properties(){return{elements:{type:Array},__observer:{type:Object},__timeout:{type:Object}}}constructor(){super(),this.elements=[],this.__timeout=!1,this.__observer=new MutationObserver((t=>this.checkMutations(t)))}loadElement(t){this.elements.length<1&&(this.__observer.observe(document,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.updateElements(),document.addEventListener("load",this.updateElements),window.addEventListener("resize",this._handleResize)),this.elements.push(t),t.style.top=0,t.style.left=0,this.positionElement(t)}unloadElement(t){this.elements.filter((e=>e===t)),this.elements.length<1&&this.removeEventListeners()}_handleResize(){this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(window.AbsolutePositionStateManager.instance.updateElements(),250)}checkMutations(t){let e=!1;t.forEach((t=>{e||(e=e||!("attributes"===t.type&&"style"===t.attributeName&&this.elements.includes(t.target)))})),e&&this.updateElements()}findTarget(t){let e="#"+t.for,o=t.target,i=t;for(;t.for&&!o&&i&&i.parentNode&&i!==document;)i=i.parentNode,o=i?i.querySelector(e):void 0,11===i.nodeType&&(i=i.host),o=!o&&i?i.querySelector(e):o;return o}removeEventListeners(){this.__observer&&this.__observer.disconnect&&this.__observer.disconnect(),document.removeEventListener("load",this.updateElements),window.removeEventListener("resize",this._handleResize)}updateElements(){this.elements.forEach((t=>this.positionElement(t)))}_getParentNode(t){let e=t.parentNode;return null!=e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&(e=e.host),e}positionElement(t){t.position||(t.position="bottom");let e=this.findTarget(t),o=t.offsetParent,i=!e||e.getBoundingClientRect();if(!e||!o)return;t.justify&&(t.style.width=`${i.width}px`);let n=parseFloat(t.offset),s=document.body.getBoundingClientRect(),l=o.getBoundingClientRect(),a=t.getBoundingClientRect(),vertical=(e=t.position)=>"left"!==e&&"right"!==e,setAlign=(e=vertical(t.position))=>{let pxToNum=t=>parseFloat(t.replace("px","")),o=e?pxToNum(t.style.left)-a.left:pxToNum(t.style.top)-a.top,n=e?"left":"top",distance=t=>e?t.width:t.height,l=o+distance(s)-distance(a),r=o;return"end"===t.positionAlign?r+=i[n]-distance(a)+distance(i):"start"===t.positionAlign?r+=i[n]:r+=i[n]-distance(a)/2+distance(i)/2,t.fitToVisibleBounds?Math.max(o,Math.min(l,r))+"px":r+"px"},getCoord=(e=t.position)=>{let pxToNum=t=>parseFloat(t.replace("px","")),o=vertical(e)?pxToNum(t.style.top)-a.top:pxToNum(t.style.left)-a.left,s="visible"==window.getComputedStyle(t,null).overflowY?Math.max(a.height,t.scrollHeight):a.height,l="visible"==window.getComputedStyle(t,null).overflowX?Math.max(a.width,t.scrollWidth):a.width;return"top"===e?i.top+o-s-n+"px":"left"===e?i.left+o-l-n+"px":i[e]+o+n+"px"},isFit=(e=t.position)=>{let distance=t=>vertical(e)?a.height+n:a.width+n;return((e=t.position)=>"left"===e||"top"===e)(e)?i[e]-s[e]>distance:s[e]-i[e]>distance},r=!1!==t.fitToVisibleBounds&&!isFit(t.position),p={top:["bottom","left","right"],left:["right","top","bottom"],bottom:["top","right","left"],right:["left","bottom","top"]};t.style.position="absolute",r&&isFit(p[t.position][0])?t.position=p[t.position][0]:r&&isFit(p[t.position][1])?t.position=p[t.position][1]:r&&isFit(p[t.position][2])?t.position=p[t.position][2]:(t.style.top=vertical(t.position)?getCoord():setAlign(),t.style.left=vertical(t.position)?setAlign():getCoord(),t.__positions={self:a,parent:l,target:i})}disconnectedCallback(){this.removeEventListeners(),super.disconnectedCallback()}}window.customElements.define(AbsolutePositionStateManager.tag,AbsolutePositionStateManager);export{AbsolutePositionStateManager};