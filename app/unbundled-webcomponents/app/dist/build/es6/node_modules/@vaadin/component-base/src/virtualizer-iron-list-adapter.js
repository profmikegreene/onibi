/**
 * @license
 * Copyright (c) 2021 - 2022 Vaadin Ltd.
 * This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
 */
import{animationFrame as e,timeOut as t}from"./async.js";import{isSafari as s}from"./browser-utils.js";import{Debouncer as i,flush as r}from"./debounce.js";import{ironList as l}from"./iron-list-core.js";export class IronListAdapter{constructor({createElements:e,updateElement:t,scrollTarget:s,scrollContainer:i,elementsContainer:r,reorderElements:l}){this.isAttached=!0,this._vidxOffset=0,this.createElements=e,this.updateElement=t,this.scrollTarget=s,this.scrollContainer=i,this.elementsContainer=r||i,this.reorderElements=l,this._maxPages=1.3,this.timeouts={SCROLL_REORDER:500,IGNORE_WHEEL:500},this.__resizeObserver=new ResizeObserver((()=>this._resizeHandler())),"visible"===getComputedStyle(this.scrollTarget).overflow&&(this.scrollTarget.style.overflow="auto"),"static"===getComputedStyle(this.scrollContainer).position&&(this.scrollContainer.style.position="relative"),this.__resizeObserver.observe(this.scrollTarget),this.scrollTarget.addEventListener("scroll",(()=>this._scrollHandler())),this._scrollLineHeight=this._getScrollLineHeight(),this.scrollTarget.addEventListener("wheel",(e=>this.__onWheel(e))),this.reorderElements&&(this.scrollTarget.addEventListener("mousedown",(()=>this.__mouseDown=!0)),this.scrollTarget.addEventListener("mouseup",(()=>{this.__mouseDown=!1,this.__pendingReorder&&this.__reorderElements()})))}_manageFocus(){}_removeFocusedItem(){}get scrollOffset(){return 0}get adjustedFirstVisibleIndex(){return this.firstVisibleIndex+this._vidxOffset}get adjustedLastVisibleIndex(){return this.lastVisibleIndex+this._vidxOffset}scrollToIndex(e){if("number"!=typeof e||isNaN(e)||0===this.size||!this.scrollTarget.offsetHeight)return;e=this._clamp(e,0,this.size-1);const t=this.__getVisibleElements().length;let s=Math.floor(e/this.size*this._virtualCount);this._virtualCount-s<t?(s=this._virtualCount-(this.size-e),this._vidxOffset=this.size-this._virtualCount):s<t?e<1e3?(s=e,this._vidxOffset=0):(s=1e3,this._vidxOffset=e-s):this._vidxOffset=e-s,this.__skipNextVirtualIndexAdjust=!0,super.scrollToIndex(s),this.adjustedFirstVisibleIndex!==e&&this._scrollTop<this._maxScrollTop&&!this.grid&&(this._scrollTop-=this.__getIndexScrollOffset(e)||0),this._scrollHandler()}flush(){0!==this.scrollTarget.offsetHeight&&(this._resizeHandler(),r(),this._scrollHandler(),this.__scrollReorderDebouncer&&this.__scrollReorderDebouncer.flush(),this.__debouncerWheelAnimationFrame&&this.__debouncerWheelAnimationFrame.flush())}update(e=0,t=this.size-1){this.__getVisibleElements().forEach((s=>{s.__virtualIndex>=e&&s.__virtualIndex<=t&&this.__updateElement(s,s.__virtualIndex,!0)}))}__updateElement(e,t,s){e.style.minHeight&&(e.style.minHeight=""),this.__preventElementUpdates||e.__lastUpdatedIndex===t&&!s||(this.updateElement(e,t),e.__lastUpdatedIndex=t),0===e.offsetHeight&&(e.style.minHeight="200px")}__getIndexScrollOffset(e){const t=this.__getVisibleElements().find((t=>t.__virtualIndex===e));return t?this.scrollTarget.getBoundingClientRect().top-t.getBoundingClientRect().top:void 0}set size(e){if(e===this.size)return;let t,s;if(this.__preventElementUpdates=!0,e>0&&(t=this.adjustedFirstVisibleIndex,s=this.__getIndexScrollOffset(t)),this.__size=e,r(),this._itemsChanged({path:"items"}),r(),e>0){t=Math.min(t,e-1),this.scrollToIndex(t);const i=this.__getIndexScrollOffset(t);void 0!==s&&void 0!==i&&(this._scrollTop+=s-i)}this.elementsContainer.children.length||requestAnimationFrame((()=>this._resizeHandler())),this.__preventElementUpdates=!1,this._resizeHandler(),r()}get size(){return this.__size}get _scrollTop(){return this.scrollTarget.scrollTop}set _scrollTop(e){this.scrollTarget.scrollTop=e}get items(){return{length:Math.min(this.size,1e5)}}get offsetHeight(){return this.scrollTarget.offsetHeight}get $(){return{items:this.scrollContainer}}updateViewportBoundaries(){const e=window.getComputedStyle(this.scrollTarget);this._scrollerPaddingTop=this.scrollTarget===this?0:parseInt(e["padding-top"],10),this._isRTL=Boolean("rtl"===e.direction),this._viewportWidth=this.elementsContainer.offsetWidth,this._viewportHeight=this.scrollTarget.offsetHeight,this._scrollPageHeight=this._viewportHeight-this._scrollLineHeight,this.grid&&this._updateGridMetrics()}setAttribute(){}_createPool(e){const t=this.createElements(e),s=document.createDocumentFragment();return t.forEach((e=>{e.style.position="absolute",s.appendChild(e),this.__resizeObserver.observe(e)})),this.elementsContainer.appendChild(s),t}_assignModels(e){this._iterateItems(((e,t)=>{const s=this._physicalItems[e];s.hidden=t>=this.size,s.hidden?delete s.__lastUpdatedIndex:(s.__virtualIndex=t+(this._vidxOffset||0),this.__updateElement(s,s.__virtualIndex))}),e)}_isClientFull(){return setTimeout((()=>this.__clientFull=!0)),this.__clientFull||super._isClientFull()}translate3d(e,t,s,i){i.style.transform=`translateY(${t})`}toggleScrollListener(){}_scrollHandler(){this._adjustVirtualIndexOffset(this._scrollTop-(this.__previousScrollTop||0)),super._scrollHandler(),this.reorderElements&&(this.__scrollReorderDebouncer=i.debounce(this.__scrollReorderDebouncer,t.after(this.timeouts.SCROLL_REORDER),(()=>this.__reorderElements()))),this.__previousScrollTop=this._scrollTop}__onWheel(s){if(s.ctrlKey||this._hasScrolledAncestor(s.target,s.deltaX,s.deltaY))return;let r=s.deltaY;if(s.deltaMode===WheelEvent.DOM_DELTA_LINE?r*=this._scrollLineHeight:s.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(r*=this._scrollPageHeight),this._deltaYAcc=this._deltaYAcc||0,this._wheelAnimationFrame)return this._deltaYAcc+=r,void s.preventDefault();r+=this._deltaYAcc,this._deltaYAcc=0,this._wheelAnimationFrame=!0,this.__debouncerWheelAnimationFrame=i.debounce(this.__debouncerWheelAnimationFrame,e,(()=>this._wheelAnimationFrame=!1));const l=Math.abs(s.deltaX)+Math.abs(r);this._canScroll(this.scrollTarget,s.deltaX,r)?(s.preventDefault(),this.scrollTarget.scrollTop+=r,this.scrollTarget.scrollLeft+=s.deltaX,this._hasResidualMomentum=!0,this._ignoreNewWheel=!0,this._debouncerIgnoreNewWheel=i.debounce(this._debouncerIgnoreNewWheel,t.after(this.timeouts.IGNORE_WHEEL),(()=>this._ignoreNewWheel=!1))):this._hasResidualMomentum&&l<=this._previousMomentum||this._ignoreNewWheel?s.preventDefault():l>this._previousMomentum&&(this._hasResidualMomentum=!1),this._previousMomentum=l}_hasScrolledAncestor(e,t,s){return e!==this.scrollTarget&&e!==this.scrollTarget.getRootNode().host&&(!(!this._canScroll(e,t,s)||-1===["auto","scroll"].indexOf(getComputedStyle(e).overflow))||(e!==this&&e.parentElement?this._hasScrolledAncestor(e.parentElement,t,s):void 0))}_canScroll(e,t,s){return s>0&&e.scrollTop<e.scrollHeight-e.offsetHeight||s<0&&e.scrollTop>0||t>0&&e.scrollLeft<e.scrollWidth-e.offsetWidth||t<0&&e.scrollLeft>0}_getScrollLineHeight(){const e=document.createElement("div");e.style.fontSize="initial",e.style.display="none",document.body.appendChild(e);const t=window.getComputedStyle(e).fontSize;return document.body.removeChild(e),t?window.parseInt(t):void 0}__getVisibleElements(){return Array.from(this.elementsContainer.children).filter((e=>!e.hidden))}__reorderElements(){if(this.__mouseDown)return void(this.__pendingReorder=!0);this.__pendingReorder=!1;const e=this._virtualStart+(this._vidxOffset||0),t=this.__getVisibleElements(),i=t.find((e=>e.contains(this.elementsContainer.getRootNode().activeElement)||e.contains(this.scrollTarget.getRootNode().activeElement)))||t[0];if(!i)return;const r=i.__virtualIndex-e,l=t.indexOf(i)-r;if(l>0)for(let e=0;e<l;e++)this.elementsContainer.appendChild(t[e]);else if(l<0)for(let e=t.length+l;e<t.length;e++)this.elementsContainer.insertBefore(t[e],t[0]);if(s){const{transform:e}=this.scrollTarget.style;this.scrollTarget.style.transform="translateZ(0)",setTimeout((()=>this.scrollTarget.style.transform=e))}}_adjustVirtualIndexOffset(e){if(this._virtualCount>=this.size)this._vidxOffset=0;else{if(this.__skipNextVirtualIndexAdjust)return void(this.__skipNextVirtualIndexAdjust=!1);if(Math.abs(e)>1e4){const e=this._scrollTop/(this.scrollTarget.scrollHeight-this.scrollTarget.offsetHeight),t=e*this.size;this._vidxOffset=Math.round(t-e*this._virtualCount)}else{const e=this._vidxOffset,t=1e3,s=100;0===this._scrollTop?(this._vidxOffset=0,e!==this._vidxOffset&&super.scrollToIndex(0)):this.firstVisibleIndex<t&&this._vidxOffset>0&&(this._vidxOffset-=Math.min(this._vidxOffset,s),super.scrollToIndex(this.firstVisibleIndex+(e-this._vidxOffset)));const i=this.size-this._virtualCount;this._scrollTop>=this._maxScrollTop&&this._maxScrollTop>0?(this._vidxOffset=i,e!==this._vidxOffset&&super.scrollToIndex(this._virtualCount-1)):this.firstVisibleIndex>this._virtualCount-t&&this._vidxOffset<i&&(this._vidxOffset+=Math.min(i-this._vidxOffset,s),super.scrollToIndex(this.firstVisibleIndex-(this._vidxOffset-e)))}}}}Object.setPrototypeOf(IronListAdapter.prototype,l);