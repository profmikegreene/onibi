/**
 * @license
 * Copyright (c) 2016 - 2022 Vaadin Ltd.
 * This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
 */
import{FlattenedNodesObserver as e}from"../../../@polymer/polymer/lib/utils/flattened-nodes-observer.js";import{PolymerElement as t}from"../../../@polymer/polymer/polymer-element.js";import{timeOut as r}from"../../component-base/src/async.js";import{Debouncer as o}from"../../component-base/src/debounce.js";export const DynamicColumnsMixin=n=>class DynamicColumnsMixin extends n{static get properties(){return{_columnTree:Object}}ready(){super.ready(),this._addNodeObserver()}_hasColumnGroups(e){for(let t=0;t<e.length;t++)if("vaadin-grid-column-group"===e[t].localName)return!0;return!1}_getChildColumns(t){return e.getFlattenedNodes(t).filter(this._isColumnElement)}_flattenColumnGroups(e){return e.map((e=>"vaadin-grid-column-group"===e.localName?this._getChildColumns(e):[e])).reduce(((e,t)=>e.concat(t)),[])}_getColumnTree(){const t=[];for(let r=e.getFlattenedNodes(this).filter(this._isColumnElement);t.push(r),this._hasColumnGroups(r);)r=this._flattenColumnGroups(r);return t}_updateColumnTree(){const e=this._getColumnTree();this._arrayEquals(e,this._columnTree)||(this._columnTree=e)}_addNodeObserver(){this._observer=new e(this,(e=>{const hasColumnElements=e=>e.filter(this._isColumnElement).length>0;if(hasColumnElements(e.addedNodes)||hasColumnElements(e.removedNodes)){const t=e.removedNodes.flatMap((e=>e._allCells)),filterNotConnected=e=>t.filter((t=>t._content.contains(e))).length;this.__removeSorters(this._sorters.filter(filterNotConnected)),this.__removeFilters(this._filters.filter(filterNotConnected)),this._updateColumnTree()}this._debouncerCheckImports=o.debounce(this._debouncerCheckImports,r.after(2e3),this._checkImports.bind(this)),this._ensureFirstPageLoaded()}))}_arrayEquals(e,t){if(!e||!t||e.length!=t.length)return!1;for(let r=0,o=e.length;r<o;r++)if(e[r]instanceof Array&&t[r]instanceof Array){if(!this._arrayEquals(e[r],t[r]))return!1}else if(e[r]!=t[r])return!1;return!0}_checkImports(){["vaadin-grid-column-group","vaadin-grid-filter","vaadin-grid-filter-column","vaadin-grid-tree-toggle","vaadin-grid-selection-column","vaadin-grid-sort-column","vaadin-grid-sorter"].forEach((e=>{const r=this.querySelector(e);!r||r instanceof t||console.warn(`Make sure you have imported the required module for <${e}> element.`)}))}_updateFirstAndLastColumn(){Array.from(this.shadowRoot.querySelectorAll("tr")).forEach((e=>this._updateFirstAndLastColumnForRow(e)))}_updateFirstAndLastColumnForRow(e){Array.from(e.querySelectorAll('[part~="cell"]:not([part~="details-cell"])')).sort(((e,t)=>e._column._order-t._column._order)).forEach(((e,t,r)=>{e.toggleAttribute("first-column",0===t),e.toggleAttribute("last-column",t===r.length-1)}))}_isColumnElement(e){return e.nodeType===Node.ELEMENT_NODE&&/\bcolumn\b/.test(e.localName)}};