/**
 * @license
 * Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
 * This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
 * The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
 * The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
 * Code distributed by Google as part of the polymer project is also
 * subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
 */
import{animationFrame as t,idlePeriod as i,microTask as s}from"./async.js";import{Debouncer as e,enqueueDebouncer as h,flush as l}from"./debounce.js";const r=navigator.userAgent.match(/iP(?:hone|ad;(?: U;)? CPU) OS (\d+)/),a=r&&r[1]>=8;export const ironList={_ratio:.5,_scrollerPaddingTop:0,_scrollPosition:0,_physicalSize:0,_physicalAverage:0,_physicalAverageCount:0,_physicalTop:0,_virtualCount:0,_estScrollHeight:0,_scrollHeight:0,_viewportHeight:0,_viewportWidth:0,_physicalItems:null,_physicalSizes:null,_firstVisibleIndexVal:null,_lastVisibleIndexVal:null,_maxPages:2,_itemsPerRow:1,_itemWidth:0,_rowHeight:0,_templateCost:0,_parentModel:!0,get _physicalBottom(){return this._physicalTop+this._physicalSize},get _scrollBottom(){return this._scrollPosition+this._viewportHeight},get _virtualEnd(){return this._virtualStart+this._physicalCount-1},get _hiddenContentSize(){return(this.grid?this._physicalRows*this._rowHeight:this._physicalSize)-this._viewportHeight},get _maxScrollTop(){return this._estScrollHeight-this._viewportHeight+this._scrollOffset},get _maxVirtualStart(){var t=this._convertIndexToCompleteRow(this._virtualCount);return Math.max(0,t-this._physicalCount)},set _virtualStart(t){t=this._clamp(t,0,this._maxVirtualStart),this.grid&&(t-=t%this._itemsPerRow),this._virtualStartVal=t},get _virtualStart(){return this._virtualStartVal||0},set _physicalStart(t){(t%=this._physicalCount)<0&&(t=this._physicalCount+t),this.grid&&(t-=t%this._itemsPerRow),this._physicalStartVal=t},get _physicalStart(){return this._physicalStartVal||0},get _physicalEnd(){return(this._physicalStart+this._physicalCount-1)%this._physicalCount},set _physicalCount(t){this._physicalCountVal=t},get _physicalCount(){return this._physicalCountVal||0},get _optPhysicalSize(){return 0===this._viewportHeight?1/0:this._viewportHeight*this._maxPages},get _isVisible(){return Boolean(this.offsetWidth||this.offsetHeight)},get firstVisibleIndex(){var t=this._firstVisibleIndexVal;if(null==t){var i=this._physicalTop+this._scrollOffset;t=this._iterateItems((function(t,s){return(i+=this._getPhysicalSizeIncrement(t))>this._scrollPosition?this.grid?s-s%this._itemsPerRow:s:this.grid&&this._virtualCount-1===s?s-s%this._itemsPerRow:void 0}))||0,this._firstVisibleIndexVal=t}return t},get lastVisibleIndex(){var t=this._lastVisibleIndexVal;if(null==t){if(this.grid)t=Math.min(this._virtualCount,this.firstVisibleIndex+this._estRowsInView*this._itemsPerRow-1);else{var i=this._physicalTop+this._scrollOffset;this._iterateItems((function(s,e){i<this._scrollBottom&&(t=e),i+=this._getPhysicalSizeIncrement(s)}))}this._lastVisibleIndexVal=t}return t},get _defaultScrollTarget(){return this},get _virtualRowCount(){return Math.ceil(this._virtualCount/this._itemsPerRow)},get _estRowsInView(){return Math.ceil(this._viewportHeight/this._rowHeight)},get _physicalRows(){return Math.ceil(this._physicalCount/this._itemsPerRow)},get _scrollOffset(){return this._scrollerPaddingTop+this.scrollOffset},_scrollHandler:function(){var t=Math.max(0,Math.min(this._maxScrollTop,this._scrollTop)),i=t-this._scrollPosition,e=i>=0;if(this._scrollPosition=t,this._firstVisibleIndexVal=null,this._lastVisibleIndexVal=null,Math.abs(i)>this._physicalSize&&this._physicalSize>0){i-=this._scrollOffset;var h=Math.round(i/this._physicalAverage)*this._itemsPerRow;this._virtualStart=this._virtualStart+h,this._physicalStart=this._physicalStart+h,this._physicalTop=Math.min(Math.floor(this._virtualStart/this._itemsPerRow)*this._physicalAverage,this._scrollPosition),this._update()}else if(this._physicalCount>0){var l=this._getReusables(e);e?(this._physicalTop=l.physicalTop,this._virtualStart=this._virtualStart+l.indexes.length,this._physicalStart=this._physicalStart+l.indexes.length):(this._virtualStart=this._virtualStart-l.indexes.length,this._physicalStart=this._physicalStart-l.indexes.length),this._update(l.indexes,e?null:l.indexes),this._debounce("_increasePoolIfNeeded",this._increasePoolIfNeeded.bind(this,0),s)}},_getReusables:function(t){var i,s,e,h=[],l=this._hiddenContentSize*this._ratio,r=this._virtualStart,a=this._virtualEnd,o=this._physicalCount,_=this._physicalTop+this._scrollOffset,n=this._physicalBottom+this._scrollOffset,c=this._scrollPosition,u=this._scrollBottom;for(t?(i=this._physicalStart,this._physicalEnd,s=c-_):(i=this._physicalEnd,this._physicalStart,s=n-u);s-=e=this._getPhysicalSizeIncrement(i),!(h.length>=o||s<=l);)if(t){if(a+h.length+1>=this._virtualCount)break;if(_+e>=c-this._scrollOffset)break;h.push(i),_+=e,i=(i+1)%o}else{if(r-h.length<=0)break;if(_+this._physicalSize-e<=u)break;h.push(i),_-=e,i=0===i?o-1:i-1}return{indexes:h,physicalTop:_-this._scrollOffset}},_update:function(t,i){if(!(t&&0===t.length||0===this._physicalCount)){if(this._manageFocus(),this._assignModels(t),this._updateMetrics(t),i)for(;i.length;){var s=i.pop();this._physicalTop-=this._getPhysicalSizeIncrement(s)}this._positionItems(),this._updateScrollerSize()}},_isClientFull:function(){return 0!=this._scrollBottom&&this._physicalBottom-1>=this._scrollBottom&&this._physicalTop<=this._scrollPosition},_increasePoolIfNeeded:function(t){var e=this._clamp(this._physicalCount+t,3,this._virtualCount-this._virtualStart);if(e=this._convertIndexToCompleteRow(e),this.grid){var h=e%this._itemsPerRow;h&&e-h<=this._physicalCount&&(e+=this._itemsPerRow),e-=h}var l=e-this._physicalCount,r=Math.round(.5*this._physicalCount);if(!(l<0)){if(l>0){var a=window.performance.now();[].push.apply(this._physicalItems,this._createPool(l));for(var o=0;o<l;o++)this._physicalSizes.push(0);this._physicalCount=this._physicalCount+l,this._physicalStart>this._physicalEnd&&this._isIndexRendered(this._focusedVirtualIndex)&&this._getPhysicalIndex(this._focusedVirtualIndex)<this._physicalEnd&&(this._physicalStart=this._physicalStart+l),this._update(),this._templateCost=(window.performance.now()-a)/l,r=Math.round(.5*this._physicalCount)}this._virtualEnd>=this._virtualCount-1||0===r||(this._isClientFull()?this._physicalSize<this._optPhysicalSize&&this._debounce("_increasePoolIfNeeded",this._increasePoolIfNeeded.bind(this,this._clamp(Math.round(50/this._templateCost),1,r)),i):this._debounce("_increasePoolIfNeeded",this._increasePoolIfNeeded.bind(this,r),s))}},_render:function(){if(this.isAttached&&this._isVisible)if(0!==this._physicalCount){var t=this._getReusables(!0);this._physicalTop=t.physicalTop,this._virtualStart=this._virtualStart+t.indexes.length,this._physicalStart=this._physicalStart+t.indexes.length,this._update(t.indexes),this._update(),this._increasePoolIfNeeded(0)}else this._virtualCount>0&&(this.updateViewportBoundaries(),this._increasePoolIfNeeded(3))},_gridChanged:function(t,i){void 0!==i&&(this.notifyResize(),l(),t&&this._updateGridMetrics())},_itemsChanged:function(i){if("items"===i.path)this._virtualStart=0,this._physicalTop=0,this._virtualCount=this.items?this.items.length:0,this._physicalIndexForKey={},this._firstVisibleIndexVal=null,this._lastVisibleIndexVal=null,this._physicalCount=this._physicalCount||0,this._physicalItems=this._physicalItems||[],this._physicalSizes=this._physicalSizes||[],this._physicalStart=0,this._scrollTop>this._scrollOffset&&this._resetScrollPosition(0),this._removeFocusedItem(),this._debounce("_render",this._render,t);else if("items.splices"===i.path){if(this._adjustVirtualIndex(i.value.indexSplices),this._virtualCount=this.items?this.items.length:0,i.value.indexSplices.some((function(t){return t.addedCount>0||t.removed.length>0}))){var s=this._getActiveElement();this.contains(s)&&s.blur()}var e=i.value.indexSplices.some((function(t){return t.index+t.addedCount>=this._virtualStart&&t.index<=this._virtualEnd}),this);this._isClientFull()&&!e||this._debounce("_render",this._render,t)}else"items.length"!==i.path&&this._forwardItemPath(i.path,i.value)},_iterateItems:function(t,i){var s,e,h,l;if(2===arguments.length&&i){for(l=0;l<i.length;l++)if(s=i[l],e=this._computeVidx(s),null!=(h=t.call(this,s,e)))return h}else{for(s=this._physicalStart,e=this._virtualStart;s<this._physicalCount;s++,e++)if(null!=(h=t.call(this,s,e)))return h;for(s=0;s<this._physicalStart;s++,e++)if(null!=(h=t.call(this,s,e)))return h}},_computeVidx:function(t){return t>=this._physicalStart?this._virtualStart+(t-this._physicalStart):this._virtualStart+(this._physicalCount-this._physicalStart)+t},_updateMetrics:function(t){l();var i=0,s=0,e=this._physicalAverageCount,h=this._physicalAverage;this._iterateItems((function(t,e){s+=this._physicalSizes[t],this._physicalSizes[t]=this._physicalItems[t].offsetHeight,i+=this._physicalSizes[t],this._physicalAverageCount+=this._physicalSizes[t]?1:0}),t),this.grid?(this._updateGridMetrics(),this._physicalSize=Math.ceil(this._physicalCount/this._itemsPerRow)*this._rowHeight):(s=1===this._itemsPerRow?s:Math.ceil(this._physicalCount/this._itemsPerRow)*this._rowHeight,this._physicalSize=this._physicalSize+i-s,this._itemsPerRow=1),this._physicalAverageCount!==e&&(this._physicalAverage=Math.round((h*e+i)/this._physicalAverageCount))},_updateGridMetrics:function(){this._itemWidth=this._physicalCount>0?this._physicalItems[0].getBoundingClientRect().width:200,this._rowHeight=this._physicalCount>0?this._physicalItems[0].offsetHeight:200,this._itemsPerRow=this._itemWidth?Math.floor(this._viewportWidth/this._itemWidth):this._itemsPerRow},_positionItems:function(){this._adjustScrollPosition();var t=this._physicalTop;if(this.grid){var i=this._itemsPerRow*this._itemWidth,s=(this._viewportWidth-i)/2;this._iterateItems((function(i,e){var h=e%this._itemsPerRow,l=Math.floor(h*this._itemWidth+s);this._isRTL&&(l*=-1),this.translate3d(l+"px",t+"px",0,this._physicalItems[i]),this._shouldRenderNextRow(e)&&(t+=this._rowHeight)}))}else{const i=[];this._iterateItems((function(s,e){const h=this._physicalItems[s];this.translate3d(0,t+"px",0,h),t+=this._physicalSizes[s];const l=h.id;l&&i.push(l)})),i.length&&this.setAttribute("aria-owns",i.join(" "))}},_getPhysicalSizeIncrement:function(t){return this.grid?this._computeVidx(t)%this._itemsPerRow!=this._itemsPerRow-1?0:this._rowHeight:this._physicalSizes[t]},_shouldRenderNextRow:function(t){return t%this._itemsPerRow==this._itemsPerRow-1},_adjustScrollPosition:function(){var t=0===this._virtualStart?this._physicalTop:Math.min(this._scrollPosition+this._physicalTop,0);if(0!==t){this._physicalTop=this._physicalTop-t;var i=this._scrollPosition;!a&&i>0&&this._resetScrollPosition(i-t)}},_resetScrollPosition:function(t){this.scrollTarget&&t>=0&&(this._scrollTop=t,this._scrollPosition=this._scrollTop)},_updateScrollerSize:function(t){this.grid?this._estScrollHeight=this._virtualRowCount*this._rowHeight:this._estScrollHeight=this._physicalBottom+Math.max(this._virtualCount-this._physicalCount-this._virtualStart,0)*this._physicalAverage,((t=(t=(t=t||0===this._scrollHeight)||this._scrollPosition>=this._estScrollHeight-this._physicalSize)||this.grid&&this.$.items.style.height<this._estScrollHeight)||Math.abs(this._estScrollHeight-this._scrollHeight)>=this._viewportHeight)&&(this.$.items.style.height=this._estScrollHeight+"px",this._scrollHeight=this._estScrollHeight)},scrollToIndex:function(t){if(!("number"!=typeof t||t<0||t>this.items.length-1)&&(l(),0!==this._physicalCount)){t=this._clamp(t,0,this._virtualCount-1),(!this._isIndexRendered(t)||t>=this._maxVirtualStart)&&(this._virtualStart=this.grid?t-2*this._itemsPerRow:t-1),this._manageFocus(),this._assignModels(),this._updateMetrics(),this._physicalTop=Math.floor(this._virtualStart/this._itemsPerRow)*this._physicalAverage;for(var i=this._physicalStart,s=this._virtualStart,e=0,h=this._hiddenContentSize;s<t&&e<=h;)e+=this._getPhysicalSizeIncrement(i),i=(i+1)%this._physicalCount,s++;this._updateScrollerSize(!0),this._positionItems(),this._resetScrollPosition(this._physicalTop+this._scrollOffset+e),this._increasePoolIfNeeded(0),this._firstVisibleIndexVal=null,this._lastVisibleIndexVal=null}},_resetAverage:function(){this._physicalAverage=0,this._physicalAverageCount=0},_resizeHandler:function(){this._debounce("_render",(function(){this._firstVisibleIndexVal=null,this._lastVisibleIndexVal=null,this._isVisible?(this.updateViewportBoundaries(),this.toggleScrollListener(!0),this._resetAverage(),this._render()):this.toggleScrollListener(!1)}),t)},updateSizeForItem:function(t){return this.updateSizeForIndex(this.items.indexOf(t))},updateSizeForIndex:function(t){return this._isIndexRendered(t)?(this._updateMetrics([this._getPhysicalIndex(t)]),this._positionItems(),null):null},_convertIndexToCompleteRow:function(t){return this._itemsPerRow=this._itemsPerRow||1,this.grid?Math.ceil(t/this._itemsPerRow)*this._itemsPerRow:t},_isIndexRendered:function(t){return t>=this._virtualStart&&t<=this._virtualEnd},_isIndexVisible:function(t){return t>=this.firstVisibleIndex&&t<=this.lastVisibleIndex},_getPhysicalIndex:function(t){return(this._physicalStart+(t-this._virtualStart))%this._physicalCount},_clamp:function(t,i,s){return Math.min(s,Math.max(i,t))},_debounce:function(t,i,s){this._debouncers=this._debouncers||{},this._debouncers[t]=e.debounce(this._debouncers[t],s,i.bind(this)),h(this._debouncers[t])}};